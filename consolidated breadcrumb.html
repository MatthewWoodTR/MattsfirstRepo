<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trial Balance Breadcrumb Navigation - With Nav & Header</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }

        /* Header Styles */
        .header {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 56px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background-color: #ff6600;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 400;
            color: #333;
        }

        .app-subtitle {
            color: #ff6600;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }

        .header-icon:hover {
            background-color: #f5f5f5;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
            margin-top: 56px;
        }

        /* Left Navigation */
        .left-nav {
            width: 220px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .engagement-info {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #0066cc;
            color: white;
        }

        .engagement-number {
            font-size: 12px;
            opacity: 0.9;
        }

        .engagement-name {
            font-size: 14px;
            font-weight: 600;
            margin-top: 4px;
        }

        .nav-menu {
            list-style: none;
            padding: 8px 0;
        }

        .nav-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #333;
            font-size: 14px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: #f5f5f5;
        }

        .nav-item.active {
            background-color: #e6f2ff;
            border-left-color: #0066cc;
            color: #0066cc;
            font-weight: 600;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            background-color: #f5f5f5;
        }

        /* Breadcrumb Container */
        .breadcrumb-container {
            background-color: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-button {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .breadcrumb-button:hover {
            background-color: #e6f2ff;
        }

        .breadcrumb-separator {
            color: #999;
        }

        .breadcrumb-text {
            color: #333;
            font-weight: 500;
        }

        /* Dropdown Styles */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 500px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 4px;
        }

        .dropdown-menu.show {
            display: block;
        }

        /* Right-aligned dropdown for consolidated menu */
        .dropdown-menu.right-aligned {
            left: auto;
            right: 0;
            min-width: 600px;
        }

        /* Client Tree Styles */
        .client-tree {
            padding: 8px 0;
        }

        .client-node {
            border-bottom: 1px solid #f0f0f0;
        }

        .client-node:last-child {
            border-bottom: none;
        }

        .client-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            color: #333;
        }

        .client-header:hover {
            background-color: #f5f5f5;
        }

        .client-caret {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .client-caret::before {
            content: "▶";
            font-size: 10px;
            color: #666;
        }

        .client-caret.expanded::before {
            transform: rotate(90deg);
            display: inline-block;
        }

        .client-engagements {
            display: none;
            background-color: #fafafa;
        }

        .client-engagements.show {
            display: block;
        }

        .engagement-item {
            padding: 10px 16px 10px 48px;
            cursor: pointer;
            color: #333;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .engagement-item:hover {
            background-color: #e6f2ff;
        }

        .engagement-item.selected {
            background-color: #cce5ff;
            font-weight: 600;
        }

        .engagement-item:last-child {
            border-bottom: none;
        }

        /* Nested Tree Styles (Consolidated) */
        .tree-container {
            padding: 8px 0;
        }

        .tree-node {
            position: relative;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            cursor: pointer;
            gap: 8px;
        }

        .tree-item:hover {
            background-color: #f5f5f5;
        }

        .tree-item.selected {
            background-color: #e6f2ff;
            color: #0066cc;
        }
        
        /* --- FIX: Current Node Highlight START --- */
        /* Styles for the current node as per User Story 1.7 */
        .tree-item.current-node {
            background-color: #cce5ff;
            font-weight: 600;
            border-left: 3px solid #0066cc;
        }
        /* Adjust padding to account for the new border */
        .tree-item.current-node {
            padding-left: calc(16px - 3px);
        }
        .tree-node[data-level="1"] .tree-item.current-node { padding-left: calc(16px - 3px); }
        .tree-node[data-level="2"] .tree-item.current-node { padding-left: calc(36px - 3px); }
        .tree-node[data-level="3"] .tree-item.current-node { padding-left: calc(56px - 3px); }
        .tree-node[data-level="4"] .tree-item.current-node { padding-left: calc(76px - 3px); }
        .tree-node[data-level="5"] .tree-item.current-node { padding-left: calc(96px - 3px); }
        .tree-node[data-level="6"] .tree-item.current-node { padding-left: calc(116px - 3px); }
        .tree-node[data-level="7"] .tree-item.current-node { padding-left: calc(136px - 3px); }
        .tree-node[data-level="8"] .tree-item.current-node { padding-left: calc(156px - 3px); }
        .tree-node[data-level="9"] .tree-item.current-node { padding-left: calc(176px - 3px); }
        .tree-node[data-level="10"] .tree-item.current-node { padding-left: calc(196px - 3px); }
        /* --- FIX: Current Node Highlight END --- */

        .tree-caret {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .tree-caret.expanded {
            transform: rotate(90deg);
        }

        .tree-caret::before {
            content: "▶";
            font-size: 10px;
            color: #666;
        }

        .tree-children {
            display: none;
        }

        .tree-children.expanded {
            display: block;
        }

        .tree-label {
            flex-grow: 1; /* Allow label to take up space */
            font-size: 14px;
        }

        .tree-label.bold {
            font-weight: 600;
        }

        .lock-icon {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            flex-shrink: 0;
        }

        /* --- FIX: Pop-out Icon START --- */
        .popout-icon {
            display: none; /* Hidden by default */
            font-size: 16px;
            color: #666;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .tree-item:hover .popout-icon {
            display: inline-block; /* Show on hover */
        }

        .popout-icon:hover {
            color: #0066cc; /* Hover color for the icon itself */
        }
        /* --- FIX: Pop-out Icon END --- */


        /* Indentation for nested levels */
        .tree-node[data-level="1"] .tree-item { padding-left: 16px; }
        .tree-node[data-level="2"] .tree-item { padding-left: 36px; }
        .tree-node[data-level="3"] .tree-item { padding-left: 56px; }
        .tree-node[data-level="4"] .tree-item { padding-left: 76px; }
        .tree-node[data-level="5"] .tree-item { padding-left: 96px; }
        .tree-node[data-level="6"] .tree-item { padding-left: 116px; }
        .tree-node[data-level="7"] .tree-item { padding-left: 136px; }
        .tree-node[data-level="8"] .tree-item { padding-left: 156px; }
        .tree-node[data-level="9"] .tree-item { padding-left: 176px; }
        .tree-node[data-level="10"] .tree-item { padding-left: 196px; }

        /* Action Buttons */
        .dropdown-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }

        .dropdown-action-btn {
            flex: 1;
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .dropdown-action-btn:hover {
            background-color: #f5f5f5;
        }

        /* Demo Content */
        .demo-content {
            padding: 24px;
        }

        .demo-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .demo-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .demo-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .features-list {
            list-style: none;
        }

        .feature-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #333;
        }

        .feature-item::before {
            content: "✓";
            color: #4caf50;
            font-weight: bold;
            font-size: 18px;
        }

        /* Scrollbar */
        .dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-section">
            <div class="logo">TR</div>
            <div class="app-title">
                Thomson Reuters <span class="app-subtitle">Engagement Manager</span>
            </div>
        </div>
        <div class="header-actions">
            <div class="header-icon" title="Settings">⚙</div>
            <div class="header-icon" title="Help">?</div>
            <div class="header-icon" title="Notifications">🔔</div>
            <div class="header-icon" title="Apps">⊞</div>
            <div class="header-icon" title="Profile">👤</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Navigation -->
        <div class="left-nav">
            <div class="engagement-info">
                <div class="engagement-number">1984</div>
                <div class="engagement-name">053B2 - TEST CLIENT</div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <span class="nav-icon">📊</span>
                    <span>Status</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">📁</span>
                    <span>Workpapers</span>
                </li>
                <li class="nav-item active">
                    <span class="nav-icon">⚖</span>
                    <span>Trial balance</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">📝</span>
                    <span>Journal entries</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">📋</span>
                    <span>Notes list</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">👥</span>
                    <span>Communications</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">📈</span>
                    <span>Analyze</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">🧪</span>
                    <span>Test</span>
                </li>
            </ul>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Breadcrumb -->
            <div class="breadcrumb-container">
                <div class="breadcrumb">
                    <div class="breadcrumb-item">
                        <button class="breadcrumb-button">Home</button>
                    </div>
                    <span class="breadcrumb-separator">/</span>
                    <div class="breadcrumb-item">
                        <span class="breadcrumb-text">1984 - 053B2 - TEST CLIENT</span>
                    </div>
                    <span class="breadcrumb-separator">/</span>
                    <div class="breadcrumb-item dropdown-container" id="engagementDropdown">
                        <button class="breadcrumb-button" id="engagementBtn">
                            !18decRestorauditICconprod (12/31/2024) ▼
                        </button>
                        <!-- Client List with Expandable Engagements -->
                        <div class="dropdown-menu" id="clientDropdown">
                            <div class="client-tree" id="clientTree">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            <div class="dropdown-actions">
                                <button class="dropdown-action-btn">+ Add new</button>
                                <button class="dropdown-action-btn">📂 Open</button>
                            </div>
                        </div>
                    </div>
                    <span class="breadcrumb-separator">/</span>
                    <div class="breadcrumb-item dropdown-container" id="consolidatedDropdown">
                        <button class="breadcrumb-button" id="consolidatedBtn">
                            Consolidated ▼
                        </button>
                        <!-- Nested Tree Dropdown (Right-aligned) -->
                        <div class="dropdown-menu right-aligned" id="treeDropdown">
                            <div class="tree-container" id="treeContainer">
                                <!-- Tree will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Demo Content -->
            <div class="demo-content">
                <div class="demo-card">
                    <h1 class="demo-title">Trial Balance Breadcrumb Navigation</h1>
                    <p class="demo-description">
                        This prototype demonstrates the two dropdown menus with the full Engagement Manager header and left navigation. The "Consolidated" dropdown now uses the same unified mock data as the Consolidation Setup screen.
                    </p>

                    <h3 style="margin-bottom: 12px; color: #333;">Features:</h3>
                    <ul class="features-list">
                        <li class="feature-item">Full header with Thomson Reuters branding</li>
                        <li class="feature-item">Left navigation with engagement info and menu items</li>
                        <li class="feature-item">Client dropdown with expandable engagements (3 per client)</li>
                        <li class="feature-item">Consolidated dropdown with unified, multi-level tree data</li>
                        <li class="feature-item">Current node in consolidation tree is highlighted</li>
                        <li class="feature-item">Lock icons (🔒) for finalized engagements</li>
                        <li class="feature-item">Pop-out icon (↗) on hover to open in a new tab</li>
                        <li class="feature-item">Click outside to close dropdowns</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA UNIFICATION START ---
        // The ID of the currently viewed engagement. Updated to a valid ID from the new dataset.
        const currentNodeId = 23; // 'US East Subsidiary 1'

        // Mock data for clients with their engagements (for the first dropdown)
        const clientsWithEngagements = [
            {
                id: 1,
                clientNumber: '1984',
                clientName: '053B1 - TEST CLIENT',
                engagements: [
                    { id: 101, name: '123 | 123', date: '12/31/2024', isFinalized: false },
                    { id: 102, name: '1396 | HASBRO', date: '06/30/2023', isFinalized: false },
                    { id: 103, name: '1984 | 053B1 - TEST CLIENT', date: '12/31/2023', isFinalized: false }
                ]
            },
            {
                id: 2,
                clientNumber: '1984',
                clientName: '053B2 - TEST CLIENT',
                engagements: [
                    { id: 201, name: '!18decRestorauditICconprod', date: '12/31/2024', isFinalized: false },
                    { id: 202, name: '!3MAyNPOAuditIC23', date: '12/31/2024', isFinalized: false },
                    { id: 203, name: '!3MAyNPOAuditIC23 after deleting managing cash', date: '12/31/2025', isFinalized: false }
                ]
            },
            {
                id: 3,
                clientNumber: '238622-56',
                clientName: 'EBK-AB',
                engagements: [
                    { id: 301, name: 'Year End Audit', date: '12/31/2023', isFinalized: true },
                    { id: 302, name: 'Interim Review', date: '06/30/2023', isFinalized: false },
                    { id: 303, name: 'Compilation', date: '03/31/2023', isFinalized: false }
                ]
            },
            {
                id: 4,
                clientNumber: '360810-2532',
                clientName: '3M COMPANY',
                engagements: [
                    { id: 401, name: 'Financial Audit', date: '12/31/2023', isFinalized: false },
                    { id: 402, name: 'Tax Planning', date: '12/31/2023', isFinalized: false },
                    { id: 403, name: 'Quarterly Review', date: '09/30/2023', isFinalized: true }
                ]
            }
        ];

        // This is the unified mock data, copied from `setup consolidation prototype.html`.
        // It's a flat array where hierarchy is defined by `parentId`.
        const consolidationData = [
            { id: 1, label: 'Global Consolidated', structure: 'Consolidated', balance: 'Total', clientName: '053B2 - TEST CLIENT', clientNumber: '1984', engagementName: 'Global Consolidated Group', parentId: null, level: 1, displayOrder: 1 },
            { id: 2, label: 'North America Division', structure: 'Consolidated', balance: 'Total', clientName: 'NA Client', clientNumber: '1984', engagementName: 'NA Division Engagement', parentId: 1, level: 2, displayOrder: 1 },
            { id: 3, label: 'Europe Division', structure: 'None', balance: 'Adjusted', clientName: 'EU Client', clientNumber: '1984', engagementName: 'Europe Division Engagement', parentId: 1, level: 2, displayOrder: 2 },
            { id: 4, label: 'Asia Pacific Division', structure: 'Consolidated', balance: 'Total', clientName: 'APAC Client', clientNumber: '1984', engagementName: 'APAC Division Engagement', parentId: 1, level: 2, displayOrder: 3 },
            { id: 5, label: 'US Operations', structure: 'Consolidated', balance: 'Total', clientName: 'US Client', clientNumber: '1984', engagementName: 'US Operations Engagement', parentId: 2, level: 3, displayOrder: 1 },
            { id: 6, label: 'Canada Operations', structure: 'None', balance: 'Adjusted', clientName: 'CA Client', clientNumber: '1984', engagementName: 'Canada Operations Engagement', parentId: 2, level: 3, displayOrder: 2 },
            { id: 7, label: 'UK Operations', structure: 'Consolidated', balance: 'Total', clientName: 'UK Client', clientNumber: '1984', engagementName: 'UK Operations Engagement', parentId: 3, level: 3, displayOrder: 1 },
            { id: 8, label: 'Germany Operations', structure: 'None', balance: 'Adjusted', clientName: 'DE Client', clientNumber: '1984', engagementName: 'Germany Operations Engagement', parentId: 3, level: 3, displayOrder: 2 },
            { id: 9, label: 'Japan Operations', structure: 'Consolidated', balance: 'Total', clientName: 'JP Client', clientNumber: '1984', engagementName: 'Japan Operations Engagement', parentId: 4, level: 3, displayOrder: 1 },
            { id: 10, label: 'Australia Operations', structure: 'None', balance: 'Adjusted', clientName: 'AU Client', clientNumber: '1984', engagementName: 'Australia Operations Engagement', parentId: 4, level: 3, displayOrder: 2 },
            { id: 11, label: 'US East Region', structure: 'Consolidated', balance: 'Total', clientName: 'US East Client', clientNumber: '1984', engagementName: 'US East Region Engagement', parentId: 5, level: 4, displayOrder: 1 },
            { id: 12, label: 'US West Region', structure: 'None', balance: 'Adjusted', clientName: 'US West Client', clientNumber: '1984', engagementName: 'US West Region Engagement', parentId: 5, level: 4, displayOrder: 2 },
            { id: 13, label: 'Ontario Region', structure: 'Consolidated', balance: 'Total', clientName: 'ON Client', clientNumber: '1984', engagementName: 'Ontario Region Engagement', parentId: 6, level: 4, displayOrder: 1 },
            { id: 14, label: 'Quebec Region', structure: 'None', balance: 'Adjusted', clientName: 'QC Client', clientNumber: '1984', engagementName: 'Quebec Region Engagement', parentId: 6, level: 4, displayOrder: 2 },
            { id: 15, label: 'London Region', structure: 'Consolidated', balance: 'Total', clientName: 'London Client', clientNumber: '1984', engagementName: 'London Region Engagement', parentId: 7, level: 4, displayOrder: 1 },
            { id: 16, label: 'Manchester Region', structure: 'None', balance: 'Adjusted', clientName: 'Manchester Client', clientNumber: '1984', engagementName: 'Manchester Region Engagement', parentId: 7, level: 4, displayOrder: 2 },
            { id: 17, label: 'Berlin Region', structure: 'Consolidated', balance: 'Total', clientName: 'Berlin Client', clientNumber: '1984', engagementName: 'Berlin Region Engagement', parentId: 8, level: 4, displayOrder: 1 },
            { id: 18, label: 'Munich Region', structure: 'None', balance: 'Adjusted', clientName: 'Munich Client', clientNumber: '1984', engagementName: 'Munich Region Engagement', parentId: 8, level: 4, displayOrder: 2 },
            { id: 19, label: 'Tokyo Region', structure: 'Consolidated', balance: 'Total', clientName: 'Tokyo Client', clientNumber: '1984', engagementName: 'Tokyo Region Engagement', parentId: 9, level: 4, displayOrder: 1 },
            { id: 20, label: 'Osaka Region', structure: 'None', balance: 'Adjusted', clientName: 'Osaka Client', clientNumber: '1984', engagementName: 'Osaka Region Engagement', parentId: 9, level: 4, displayOrder: 2 },
            { id: 21, label: 'Sydney Region', structure: 'Consolidated', balance: 'Total', clientName: 'Sydney Client', clientNumber: '1984', engagementName: 'Sydney Region Engagement', parentId: 10, level: 4, displayOrder: 1 },
            { id: 22, label: 'Melbourne Region', structure: 'None', balance: 'Adjusted', clientName: 'Melbourne Client', clientNumber: '1984', engagementName: 'Melbourne Region Engagement', parentId: 10, level: 4, displayOrder: 2 },
            { id: 23, label: 'US East Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 23', clientNumber: '1984', engagementName: 'Leaf Engagement 23', parentId: 11, level: 5, displayOrder: 1 },
            { id: 24, label: 'US East Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 24', clientNumber: '1984', engagementName: 'Leaf Engagement 24', parentId: 11, level: 5, displayOrder: 2 },
            { id: 25, label: 'US West Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 25', clientNumber: '1984', engagementName: 'Leaf Engagement 25', parentId: 12, level: 5, displayOrder: 1 },
            { id: 26, label: 'US West Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 26', clientNumber: '1984', engagementName: 'Leaf Engagement 26', parentId: 12, level: 5, displayOrder: 2 },
            { id: 27, label: 'Ontario Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 27', clientNumber: '1984', engagementName: 'Leaf Engagement 27', parentId: 13, level: 5, displayOrder: 1 },
            { id: 28, label: 'Ontario Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 28', clientNumber: '1984', engagementName: 'Leaf Engagement 28', parentId: 13, level: 5, displayOrder: 2 },
            { id: 29, label: 'Quebec Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 29', clientNumber: '1984', engagementName: 'Leaf Engagement 29', parentId: 14, level: 5, displayOrder: 1 },
            { id: 30, label: 'Quebec Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 30', clientNumber: '1984', engagementName: 'Leaf Engagement 30', parentId: 14, level: 5, displayOrder: 2 },
            { id: 31, label: 'London Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 31', clientNumber: '1984', engagementName: 'Leaf Engagement 31', parentId: 15, level: 5, displayOrder: 1 },
            { id: 32, label: 'London Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 32', clientNumber: '1984', engagementName: 'Leaf Engagement 32', parentId: 15, level: 5, displayOrder: 2 },
            { id: 33, label: 'Manchester Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 33', clientNumber: '1984', engagementName: 'Leaf Engagement 33', parentId: 16, level: 5, displayOrder: 1 },
            { id: 34, label: 'Manchester Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 34', clientNumber: '1984', engagementName: 'Leaf Engagement 34', parentId: 16, level: 5, displayOrder: 2 },
            { id: 35, label: 'Berlin Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 35', clientNumber: '1984', engagementName: 'Leaf Engagement 35', parentId: 17, level: 5, displayOrder: 1 },
            { id: 36, label: 'Berlin Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 36', clientNumber: '1984', engagementName: 'Leaf Engagement 36', parentId: 17, level: 5, displayOrder: 2 },
            { id: 37, label: 'Munich Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 37', clientNumber: '1984', engagementName: 'Leaf Engagement 37', parentId: 18, level: 5, displayOrder: 1 },
            { id: 38, label: 'Munich Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 38', clientNumber: '1984', engagementName: 'Leaf Engagement 38', parentId: 18, level: 5, displayOrder: 2 },
            { id: 39, label: 'Tokyo Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 39', clientNumber: '1984', engagementName: 'Leaf Engagement 39', parentId: 19, level: 5, displayOrder: 1 },
            { id: 40, label: 'Tokyo Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 40', clientNumber: '1984', engagementName: 'Leaf Engagement 40', parentId: 19, level: 5, displayOrder: 2 },
            { id: 41, label: 'Osaka Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 41', clientNumber: '1984', engagementName: 'Leaf Engagement 41', parentId: 20, level: 5, displayOrder: 1 },
            { id: 42, label: 'Osaka Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 42', clientNumber: '1984', engagementName: 'Leaf Engagement 42', parentId: 20, level: 5, displayOrder: 2 },
            { id: 43, label: 'Sydney Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 43', clientNumber: '1984', engagementName: 'Leaf Engagement 43', parentId: 21, level: 5, displayOrder: 1 },
            { id: 44, label: 'Sydney Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 44', clientNumber: '1984', engagementName: 'Leaf Engagement 44', parentId: 21, level: 5, displayOrder: 2 },
            { id: 45, label: 'Melbourne Subsidiary 1', structure: 'None', balance: 'Adjusted', clientName: 'Client 45', clientNumber: '1984', engagementName: 'Leaf Engagement 45', parentId: 22, level: 5, displayOrder: 1 },
            { id: 46, label: 'Melbourne Subsidiary 2', structure: 'None', balance: 'Adjusted', clientName: 'Client 46', clientNumber: '1984', engagementName: 'Leaf Engagement 46', parentId: 22, level: 5, displayOrder: 2 }
        ];

        /**
         * Converts a flat array of nodes (with parentId) into a nested tree structure.
         * @param {Array} flatData The flat array of nodes.
         * @returns {Array} An array of root nodes, with children nested inside.
         */
        function buildTreeFromFlatData(flatData) {
            const nodeMap = new Map();
            const tree = [];

            // First pass: create a map of all nodes by their ID
            // and initialize the children array.
            flatData.forEach(node => {
                nodeMap.set(node.id, { ...node, children: [] });
            });

            // Second pass: link children to their parents.
            flatData.forEach(node => {
                // Find the node in our map to ensure we are working with the mapped version
                const mappedNode = nodeMap.get(node.id);
                if (node.parentId !== null && nodeMap.has(node.parentId)) {
                    const parentNode = nodeMap.get(node.parentId);
                    // Add child if not already present (handles potential data inconsistencies)
                    if (!parentNode.children.some(child => child.id === mappedNode.id)) {
                       parentNode.children.push(mappedNode);
                    }
                } else {
                    // If parentId is null, it's a root node.
                    tree.push(mappedNode);
                }
            });

            // Helper function to recursively sort children by displayOrder
            const sortChildren = (node) => {
                if (node.children && node.children.length > 0) {
                    node.children.sort((a, b) => a.displayOrder - b.displayOrder);
                    node.children.forEach(sortChildren);
                }
            };
            
            // Sort children within each root node
            tree.forEach(sortChildren);
            // Sort the root nodes themselves
            tree.sort((a,b) => a.displayOrder - b.displayOrder);

            return tree;
        }

        // The procedural data generation function is no longer needed.
        // function generateTreeData(...) { ... }

        // --- DATA UNIFICATION END ---

        // Render client tree with expandable engagements
        function renderClientTree() {
            const container = document.getElementById('clientTree');
            container.innerHTML = '';

            clientsWithEngagements.forEach(client => {
                const clientNode = document.createElement('div');
                clientNode.className = 'client-node';

                // Client header
                const clientHeader = document.createElement('div');
                clientHeader.className = 'client-header';
                
                const caret = document.createElement('span');
                caret.className = 'client-caret';
                
                const clientLabel = document.createElement('span');
                clientLabel.textContent = `${client.clientNumber} | ${client.clientName}`;
                
                clientHeader.appendChild(caret);
                clientHeader.appendChild(clientLabel);

                // Engagements container
                const engagementsContainer = document.createElement('div');
                engagementsContainer.className = 'client-engagements';

                client.engagements.forEach(engagement => {
                    const engItem = document.createElement('div');
                    engItem.className = 'engagement-item';
                    const lockIcon = engagement.isFinalized ? '🔒 ' : '';
                    engItem.textContent = `${lockIcon}${engagement.name} (${engagement.date})`;
                    
                    engItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.engagement-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        engItem.classList.add('selected');
                        console.log('Selected engagement:', engagement.name);
                    });
                    engagementsContainer.appendChild(engItem);
                });

                // Toggle expand/collapse
                clientHeader.addEventListener('click', () => {
                    caret.classList.toggle('expanded');
                    engagementsContainer.classList.toggle('show');
                });

                clientNode.appendChild(clientHeader);
                clientNode.appendChild(engagementsContainer);
                container.appendChild(clientNode);
            });
        }

        // Render nested tree node
        function renderTreeNode(node, container) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'tree-node';
            nodeDiv.setAttribute('data-level', node.level);
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'tree-item';
            
            // If this node is the current one, add the special class.
            if (node.id === currentNodeId) {
                itemDiv.classList.add('current-node');
            }

            // Add caret if has children
            if (node.children && node.children.length > 0) {
                const caret = document.createElement('span');
                caret.className = `tree-caret ${node.expanded ? 'expanded' : ''}`;
                caret.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleNode(nodeDiv, caret);
                });
                itemDiv.appendChild(caret);
            } else {
                const spacer = document.createElement('span');
                spacer.style.width = '16px';
                spacer.style.flexShrink = '0';
                itemDiv.appendChild(spacer);
            }
            
            // Add lock icon for finalized engagements
            if (node.isFinalized) {
                const lockIcon = document.createElement('span');
                lockIcon.className = 'lock-icon';
                lockIcon.textContent = '🔒';
                itemDiv.appendChild(lockIcon);
            }
            
            // Add label (no date)
            const label = document.createElement('span');
            // The root node's level is 1 in the new data
            label.className = node.level === 1 ? 'tree-label bold' : 'tree-label';
            label.textContent = node.name; // Use 'name' property which was mapped from 'label'
            itemDiv.appendChild(label);
            
            const popoutIcon = document.createElement('span');
            popoutIcon.className = 'popout-icon';
            popoutIcon.innerHTML = '↗';
            popoutIcon.title = 'Open in new tab';
            popoutIcon.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent row selection
                alert(`Simulating opening "${node.name}" in a new tab.`);
            });
            itemDiv.appendChild(popoutIcon);

            // Click handler for selection
            itemDiv.addEventListener('click', () => {
                // Remove 'selected' from all
                document.querySelectorAll('.tree-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                itemDiv.classList.add('selected');
                console.log(`Selected consolidation node: ${node.name} (ID: ${node.id})`);
            });
            
            nodeDiv.appendChild(itemDiv);
            
            // Add children
            if (node.children && node.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = `tree-children ${node.expanded ? 'expanded' : ''}`;
                
                node.children.forEach(child => {
                    renderTreeNode(child, childrenDiv);
                });
                
                nodeDiv.appendChild(childrenDiv);
            }
            
            container.appendChild(nodeDiv);
        }

        // Toggle tree node
        function toggleNode(nodeDiv, caret) {
            const childrenDiv = nodeDiv.querySelector('.tree-children');
            if (childrenDiv) {
                childrenDiv.classList.toggle('expanded');
                caret.classList.toggle('expanded');
            }
        }

        // --- INITIALIZATION ---
        
        // Render the client/engagement dropdown
        renderClientTree();

        // Prepare and render the consolidated tree dropdown
        // 1. Map the source data to the format expected by renderTreeNode and add missing properties.
        const mappedConsolidationData = consolidationData.map(node => ({
            ...node,
            name: node.label, // Map 'label' to 'name'
            isFinalized: node.id % 7 === 0, // Add some random-looking finalized status for demo
            expanded: true // Expand all nodes by default to match original prototype
        }));

        // 2. Build the nested tree from the flat, mapped data.
        const treeData = buildTreeFromFlatData(mappedConsolidationData);

        // 3. Render the tree into the container.
        const treeContainer = document.getElementById('treeContainer');
        treeData.forEach(node => {
            renderTreeNode(node, treeContainer);
        });

        // Dropdown toggle logic
        const engagementBtn = document.getElementById('engagementBtn');
        const clientDropdown = document.getElementById('clientDropdown');
        const consolidatedBtn = document.getElementById('consolidatedBtn');
        const treeDropdown = document.getElementById('treeDropdown');

        engagementBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            clientDropdown.classList.toggle('show');
            treeDropdown.classList.remove('show');
        });

        consolidatedBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpening = !treeDropdown.classList.contains('show');
            treeDropdown.classList.toggle('show');
            clientDropdown.classList.remove('show');

            // If the dropdown is being opened, find the current node and scroll to it.
            if (isOpening) {
                // Use a timeout to ensure the element is visible before scrolling
                setTimeout(() => {
                    const currentNodeElement = document.querySelector('.tree-item.current-node');
                    if (currentNodeElement) {
                        // Expand all parents of the current node to make it visible
                        let parent = currentNodeElement.closest('.tree-node');
                        while(parent) {
                            const parentContainer = parent.closest('.tree-children');
                            if(parentContainer && !parentContainer.classList.contains('expanded')) {
                                parentContainer.classList.add('expanded');
                                const parentCaret = parentContainer.previousElementSibling.querySelector('.tree-caret');
                                if(parentCaret) parentCaret.classList.add('expanded');
                            }
                            parent = parent.parentElement.closest('.tree-node');
                        }

                        // Scroll the element into view
                        currentNodeElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                }, 10);
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown-container')) {
                clientDropdown.classList.remove('show');
                treeDropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>