<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
  <title>EM ‚Äî Consolidation Report Workflows Prototype</title>  
  <style>  
    <link rel="stylesheet" href="conflict-visual-indicators.css">
  </style>  
</head>  
<body>  
  <!-- Header -->  
  <div class="header">  
    <div class="logo-section">  
      <div class="logo">TR</div>  
      <div class="app-title">Thomson Reuters <span class="app-subtitle">Engagement Manager</span></div>  
    </div>  
    <div class="header-actions">  
      <div class="header-icon" title="Settings">‚öô</div>  
      <div class="header-icon" title="Help">?</div>  
      <div class="header-icon" title="Notifications">üîî</div>  
      <div class="header-icon" title="Apps">‚äû</div>  
      <div class="header-icon" title="Profile">üë§</div>  
    </div>  
  </div>
  
  <div class="main-container">  
    <!-- Left nav -->  
    <div class="left-nav">  
      <div class="engagement-info">  
        <div class="engagement-number">1984</div>  
        <div class="engagement-name" id="currentEngagementName">053B2 - TEST CLIENT</div>  
      </div>  
      <ul class="nav-menu">  
        <li class="nav-item"><span class="nav-icon">üìä</span><span>Status</span></li>  
        <li class="nav-item active"><span class="nav-icon">üìÅ</span><span>Workpapers</span></li>  
        <li class="nav-item"><span class="nav-icon">‚öñ</span><span>Trial balance</span></li>  
        <li class="nav-item"><span class="nav-icon">üìù</span><span>Journal entries</span></li>  
        <li class="nav-item"><span class="nav-icon">üìã</span><span>Notes list</span></li>  
        <li class="nav-item"><span class="nav-icon">üë•</span><span>Communications</span></li>  
        <li class="nav-item"><span class="nav-icon">üìà</span><span>Analyze</span></li>  
        <li class="nav-item"><span class="nav-icon">üß™</span><span>Test</span></li>  
      </ul>  
    </div>
  
    <!-- Content -->  
    <div class="content-area">  
      <div class="toolbar">  
        <div class="add-dropdown">  
          <button class="btn" id="btnAdd">Add ‚ñº</button>  
          <div class="add-dropdown-menu" id="addDropdown">  
            <div class="add-dropdown-item" id="addCustomExcel">Custom Excel</div>  
            <div class="add-dropdown-item">Checkpoint Tools</div>  
            <div class="add-dropdown-item">Excel</div>  
            <div class="add-dropdown-item">Existing engagement</div>  
            <div class="add-dropdown-item">External</div>  
            <div class="add-dropdown-item">GoFileRoom</div>  
            <div class="add-dropdown-item">Placeholder</div>  
            <div class="add-dropdown-item">Scan</div>  
            <div class="add-dropdown-item">Template</div>  
            <div class="add-dropdown-item">Word</div>  
          </div>  
        </div>  
        <button class="btn">Manage ‚ñº</button>  
        <button class="btn">Refresh</button>  
        <button class="btn primary" id="btnCreateReport">Create report</button>  
        <button class="btn">Confirmation</button>  
        <div class="spacer"></div>  
        <button class="btn">Columns</button>  
        <button class="btn">List View</button>  
      </div>
  
      <div class="workpaper-list">  
        <!-- Demo Controls -->  
        <div class="demo-controls">  
          <h4>Demo Controls</h4>  
          <label>  
            <input type="checkbox" id="toggleConsolidation" checked>  
            Current engagement is in consolidation hierarchy  
          </label>  
          <label>  
            <input type="checkbox" id="toggleDestination" checked>  
            Show separate save destination selector  
          </label>  
        </div>
  
        <div class="card">  
          <div style="display:flex; justify-content:space-between; align-items:center;">  
            <div>  
              <div style="font-weight:600;">Consolidation Report Workflows Prototype</div>  
              <div class="muted">This prototype demonstrates both Create Report and Custom Excel workflows with consolidation member selection as the first step.</div>  
            </div>  
            <div class="muted">  
              Current engagement in consolidation: <span id="isInGroupFlag">Yes</span>  
            </div>  
          </div>  
        </div>
  
        <!-- Workpapers Table -->  
        <div class="card">  
          <table style="width:100%; border-collapse:collapse;">  
            <thead>  
              <tr style="background:#f8f9fa; border-bottom:1px solid #ddd;">  
                <th style="padding:8px; text-align:left; font-size:12px; color:#666;">Reference</th>  
                <th style="padding:8px; text-align:left; font-size:12px; color:#666;">Description</th>  
                <th style="padding:8px; text-align:left; font-size:12px; color:#666;">Status</th>  
              </tr>  
            </thead>  
            <tbody>  
              <tr style="border-bottom:1px solid #f1f1f1;">  
                <td style="padding:8px;">üìÑ 000002NCF2</td>  
                <td style="padding:8px;">Excel</td>  
                <td style="padding:8px;">Include</td>  
              </tr>  
              <tr style="border-bottom:1px solid #f1f1f1;">  
                <td style="padding:8px;">üìÑ DocA</td>  
                <td style="padding:8px;">doc</td>  
                <td style="padding:8px;">Include</td>  
              </tr>  
              <tr>  
                <td style="padding:8px;">üóÇÔ∏è Recycle Bin</td>  
                <td style="padding:8px;"></td>  
                <td style="padding:8px;"></td>  
              </tr>  
            </tbody>  
          </table>  
        </div>  
      </div>  
    </div>  
  </div>
  
  <!-- Modal: Create Report -->  
  <div class="modal-backdrop" id="createReportBackdrop">  
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cr-title">  
      <div class="modal-header">  
        <div class="modal-title" id="cr-title">Create report</div>  
        <div class="close-x" id="cr-close">‚úï</div>  
      </div>  
      <div class="modal-body">  
        <!-- Progress Steps -->  
        <div class="progress-steps" id="createReportSteps">  
          <div class="step active" id="cr-step1">  
            <div class="step-number">1</div>  
            <span>Data Source</span>  
          </div>  
          <div class="step" id="cr-step2">  
            <div class="step-number">2</div>  
            <span>Report Type</span>  
          </div>  
          <div class="step" id="cr-step3">  
            <div class="step-number">3</div>  
            <span>Options</span>  
          </div>  
          <div class="step" id="cr-step4">  
            <div class="step-number">4</div>  
            <span>Save Location</span>  
          </div>  
        </div>
  
        <!-- Step 1: Data Source Selection -->  
        <div class="field" id="cr-dataSourceSection">  
          <div class="label">Data Source (Consolidation Member)</div>  
          <div class="row">  
            <div class="col">  
              <div class="tree-container" id="cr-dataSourceTree"></div>  
              <div class="note" id="cr-dataSourceNote">  
                Select which engagement's data will be used for the report. Defaults to current engagement.  
              </div>  
            </div>  
            <div class="col">  
              <div class="section-title">Selected Data Source</div>  
              <div id="cr-selectedDataSummary" class="hint"></div>  
              <div class="divider"></div>  
              <div class="section-title">Prerequisites Check</div>  
              <div class="hint" id="cr-prereqAccountGrouping"></div>  
              <div class="hint" id="cr-prereqTax"></div>  
            </div>  
          </div>  
        </div>
  
        <!-- Step 2: Report Type Selection -->  
        <div class="field" id="cr-reportTypeSection" style="display:none;">  
          <div class="label">Report type *</div>  
          <select id="cr-reportTypeDropdown">  
            <option value="">Select report type...</option>  
          </select>  
          <div class="note">Available reports are determined by the selected engagement's structure and setup.</div>  
        </div>
  
        <!-- Step 3: Report Options -->  
        <div class="field" id="cr-optionsSection" style="display:none;">  
          <div class="label">Report Options</div>  
          <div class="options-card" id="cr-optionsPreview">  
            <div class="hint">Select a report type to see available options.</div>  
          </div>  
        </div>
  
        <!-- Step 4: Save Destination -->  
        <div class="field" id="cr-saveDestinationSection" style="display:none;">  
          <div class="label">Save Destination</div>  
          <div class="row">  
            <div class="col">  
              <div class="tree-container" id="cr-saveDestinationTree"></div>  
              <div class="note">  
                Choose where to save the generated report. Must be within the same consolidation hierarchy.  
              </div>  
            </div>  
            <div class="col">  
              <div class="section-title">Selected Save Location</div>  
              <div id="cr-selectedDestinationSummary" class="hint"></div>  
              <div class="divider"></div>  
              <div class="section-title">Permissions</div>  
              <div class="hint" id="cr-destinationPermissions">Checking write access...</div>  
            </div>  
          </div>  
        </div>  
      </div>  
      <div class="modal-footer">  
        <div class="footer-left">  
          <button class="btn" id="cr-back" style="display:none;">‚Üê Back</button>  
        </div>  
        <div class="footer-right">  
          <button class="btn" id="cr-cancel">Cancel</button>  
          <button class="btn primary" id="cr-next">Next ‚Üí</button>  
        </div>  
      </div>  
    </div>  
  </div>
  
  <!-- Custom Excel Wizard -->  
  <div class="modal-backdrop" id="customExcelBackdrop">  
    <div class="wizard-container" style="width:900px; max-width:95vw; max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">  
      <div class="wizard-header">  
        <button class="wizard-back-btn" id="ce-backToWorkpapers">‚Üê</button>  
        <div class="wizard-title">Workpapers</div>  
      </div>  
      <div class="wizard-steps">  
        <div class="wizard-step active" id="ce-step1">  
          <div class="wizard-step-number">1</div>  
          <span>Data Source</span>  
        </div>  
        <div class="wizard-step" id="ce-step2">  
          <div class="wizard-step-number">2</div>  
          <span>Grouping Type</span>  
        </div>  
        <div class="wizard-step" id="ce-step3">  
          <div class="wizard-step-number">3</div>  
          <span>Customize options</span>  
        </div>  
        <div class="wizard-step" id="ce-step4">  
          <div class="wizard-step-number">4</div>  
          <span>Customize columns</span>  
        </div>  
        <div class="wizard-step" id="ce-step5">  
          <div class="wizard-step-number">5</div>  
          <span>Workpaper Properties</span>  
        </div>  
      </div>  
      <div class="wizard-body" style="flex:1; overflow-y:auto;">  
        <!-- Step 1: Data Source Selection -->  
        <div id="ce-dataSourceSection">  
          <h2 style="margin-bottom:16px;">Data Source</h2>  
          <div class="row">  
            <div class="col">  
              <div class="tree-container" id="ce-dataSourceTree"></div>  
              <div class="note" id="ce-dataSourceNote">  
                Select which engagement's data will be used for the Custom Excel document. Defaults to current engagement.  
              </div>  
            </div>  
            <div class="col">  
              <div class="section-title">Selected Data Source</div>  
              <div id="ce-selectedDataSummary" class="hint"></div>  
              <div class="divider"></div>  
              <div class="section-title">Prerequisites Check</div>  
              <div class="hint" id="ce-prereqAccountGrouping"></div>  
              <div class="hint" id="ce-prereqTax"></div>  
            </div>  
          </div>  
        </div>
  
        <!-- Step 2: Grouping Type Selection -->  
        <div id="ce-groupingTypeSection" style="display:none;">  
          <h2 style="margin-bottom:16px;">Grouping Type</h2>  
          <div class="field">  
            <div class="label">Grouping Type *</div>  
            <select id="ce-groupingTypeDropdown">  
              <option value="">Select grouping type...</option>  
            </select>  
            <div class="note">Only Account Grouping and Tax Code are available for Custom Excel documents. Availability depends on the selected engagement's setup.</div>  
          </div>  
        </div>
  
        <!-- Step 3: Customize Options -->  
        <div id="ce-customizeOptionsSection" style="display:none;">  
          <h2 style="margin-bottom:16px;">Customize options</h2>  
          <div class="options-card" id="ce-optionsPreview">  
            <div class="hint">Select a grouping type to see available options.</div>  
          </div>  
        </div>
  
        <!-- Step 4: Customize Columns -->  
        <div id="ce-customizeColumnsSection" style="display:none;">  
          <h2 style="margin-bottom:16px;">Customize columns</h2>  
          <div class="hint">Column customization options would appear here based on the selected engagement and grouping type.</div>  
        </div>
  
        <!-- Step 5: Workpaper Properties -->  
        <div id="ce-workpaperPropertiesSection" style="display:none;">  
          <h2 style="margin-bottom:16px;">Workpaper Properties</h2>  
          <div class="hint">Final workpaper properties and naming options would appear here.</div>  
        </div>  
      </div>  
      <div class="wizard-footer">  
        <div class="footer-left">  
          <button class="btn" id="ce-back" style="display:none;">‚Üê Back</button>  
        </div>  
        <div class="footer-right">  
          <button class="btn" id="ce-cancel">Cancel</button>  
          <button class="btn primary" id="ce-next">Next ‚Üí</button>  
        </div>  
      </div>  
    </div>  
  </div>
  
  <script>  
    // ===== Demo data =====  
    const currentEngagementContext = {  
      id: 'E-ROOT',  
      displayName: 'US East Subsidiary 1 (12/31/2024)',  
      clientDisplay: '1984 - 053B2 - TEST CLIENT',  
      isInConsolidationGroup: true  
    };
  
    // Enhanced consolidation hierarchy with more realistic data  
    const consolidationMembers = [  
      {  
        id: 'E-GLOBAL',  
        name: 'Global Consolidated',  
        structure: 'consolidated',  
        hasAccountGroupings: true,  
        hasTaxSetup: true,  
        level: 1,  
        parentId: null,  
        children: []  
      },  
      {  
        id: 'E-NA',  
        name: 'North America Division',  
        structure: 'consolidated',  
        hasAccountGroupings: true,  
        hasTaxSetup: true,  
        level: 2,  
        parentId: 'E-GLOBAL',  
        children: []  
      },  
      {  
        id: 'E-EU',  
        name: 'Europe Division',  
        structure: 'divisional',  
        hasAccountGroupings: true,  
        hasTaxSetup: false,  
        level: 2,  
        parentId: 'E-GLOBAL',  
        children: []  
      },  
      {  
        id: 'E-US',  
        name: 'US Operations',  
        structure: 'fund',  
        hasAccountGroupings: false,  
        hasTaxSetup: true,  
        level: 3,  
        parentId: 'E-NA',  
        children: []  
      },  
      {  
        id: 'E-CA',  
        name: 'Canada Operations',  
        structure: 'none',  
        hasAccountGroupings: true,  
        hasTaxSetup: true,  
        level: 3,  
        parentId: 'E-NA',  
        children: []  
      },  
      {  
        id: 'E-ROOT',  
        name: 'US East Subsidiary 1',  
        structure: 'none',  
        hasAccountGroupings: true,  
        hasTaxSetup: true,  
        level: 4,  
        parentId: 'E-US',  
        children: []  
      }  
    ];
  
    // Build tree structure  
    function buildTree(flatData) {  
      const nodeMap = new Map();  
      const tree = [];
  
      flatData.forEach(node => {  
        nodeMap.set(node.id, { ...node, children: [], expanded: true });  
      });
  
      flatData.forEach(node => {  
        const mappedNode = nodeMap.get(node.id);  
        if (node.parentId && nodeMap.has(node.parentId)) {  
          const parentNode = nodeMap.get(node.parentId);  
          parentNode.children.push(mappedNode);  
        } else {  
          tree.push(mappedNode);  
        }  
      });
  
      return tree;  
    }
  
    const treeData = buildTree(consolidationMembers);
  
    // Report catalogs by structure  
    const REPORT_CATALOG = {  
      none: [  
        { key: 'account-grouping', label: 'Account Grouping', gatedBy: 'accountGrouping' },  
        { key: 'tax-code', label: 'Tax Code', gatedBy: 'tax' },  
        { key: 'trial-balance', label: 'Trial Balance' },  
        { key: 'notes', label: 'Notes' },  
        { key: 'journal-entry', label: 'Journal Entry' }  
      ],  
      divisional: [  
        { key: 'account-grouping', label: 'Account Grouping', gatedBy: 'accountGrouping' },  
        { key: 'tax-code', label: 'Tax Code', gatedBy: 'tax' },  
        { key: 'trial-balance', label: 'Trial Balance' },  
        { key: 'notes', label: 'Notes' },  
        { key: 'journal-entry', label: 'Journal Entry' },  
        { key: 'chart-of-accounts', label: 'Chart of Accounts' },  
        { key: 'trial-balance-divisional', label: 'Trial Balance (Divisional)' },  
        { key: 'account-grouping-by-division', label: 'Account Grouping ‚Äî Columns by Division', gatedBy: 'accountGrouping' },  
        { key: 'tax-code-by-division', label: 'Tax Code ‚Äî Columns by Division', gatedBy: 'tax' }  
      ],  
      fund: [  
        { key: 'account-grouping', label: 'Account Grouping', gatedBy: 'accountGrouping' },  
        { key: 'tax-code', label: 'Tax Code', gatedBy: 'tax' },  
        { key: 'trial-balance', label: 'Trial Balance' },  
        { key: 'notes', label: 'Notes' },  
        { key: 'journal-entry', label: 'Journal Entry' },  
        { key: 'fund-trial-balance', label: 'Trial Balance (Fund)' },  
        { key: 'fund-columns', label: 'Columns by Fund' },  
        { key: 'chart-of-accounts', label: 'Chart of Accounts' }  
      ],  
      consolidated: [  
        { key: 'account-grouping', label: 'Account Grouping', gatedBy: 'accountGrouping' },  
        { key: 'tax-code', label: 'Tax Code', gatedBy: 'tax' },  
        { key: 'trial-balance', label: 'Trial Balance' },  
        { key: 'notes', label: 'Notes' },  
        { key: 'journal-entry', label: 'Journal Entry' },  
        { key: 'consolidated-trial-balance', label: 'Trial Balance (Consolidated)' },  
        { key: 'eliminations', label: 'Eliminations' },  
        { key: 'chart-of-accounts', label: 'Chart of Accounts' }  
      ]  
    };
  
    // Custom Excel only supports Account Grouping and Tax Code  
    const CUSTOM_EXCEL_CATALOG = [  
      { key: 'account-grouping', label: 'Account Grouping', gatedBy: 'accountGrouping' },  
      { key: 'tax-code', label: 'Tax Code', gatedBy: 'tax' }  
    ];
  
    // ===== State Management =====  
    let createReportStep = 1;  
    let customExcelStep = 1;  
    let selectedDataSourceId = 'E-ROOT';  
    let selectedDestinationId = 'E-ROOT';  
    let selectedReportKey = null;  
    let selectedGroupingKey = null;  
    let showDestinationSelector = true;
  
    // ===== DOM References =====  
    const btnAdd = document.getElementById('btnAdd');  
    const addDropdown = document.getElementById('addDropdown');  
    const addCustomExcel = document.getElementById('addCustomExcel');  
    const btnCreateReport = document.getElementById('btnCreateReport');  
    const toggleConsolidation = document.getElementById('toggleConsolidation');  
    const toggleDestination = document.getElementById('toggleDestination');
  
    // Create Report Modal  
    const createReportBackdrop = document.getElementById('createReportBackdrop');  
    const crClose = document.getElementById('cr-close');  
    const crCancel = document.getElementById('cr-cancel');  
    const crNext = document.getElementById('cr-next');  
    const crBack = document.getElementById('cr-back');
  
    // Custom Excel Modal  
    const customExcelBackdrop = document.getElementById('customExcelBackdrop');  
    const ceBackToWorkpapers = document.getElementById('ce-backToWorkpapers');  
    const ceCancel = document.getElementById('ce-cancel');  
    const ceNext = document.getElementById('ce-next');  
    const ceBack = document.getElementById('ce-back');
  
    // ===== Tree Rendering =====  
    function renderTreeNode(node, container, selectionType = 'dataSource', workflow = 'createReport') {  
      const nodeDiv = document.createElement('div');  
      nodeDiv.className = 'tree-node';  
      nodeDiv.setAttribute('data-level', node.level);
        
      const itemDiv = document.createElement('div');  
      itemDiv.className = 'tree-item';
        
      // Highlight current node  
      if (node.id === 'E-ROOT') {  
        itemDiv.classList.add('current-node');  
      }
  
      // Selection state  
      const selectedId = selectionType === 'dataSource' ? selectedDataSourceId : selectedDestinationId;  
      if (node.id === selectedId) {  
        itemDiv.classList.add('selected');  
      }
  
      // Caret for expandable nodes  
      if (node.children && node.children.length > 0) {  
        const caret = document.createElement('span');  
        caret.className = `tree-caret ${node.expanded ? 'expanded' : ''}`;  
        caret.addEventListener('click', (e) => {  
          e.stopPropagation();  
          toggleTreeNode(nodeDiv, caret);  
        });  
        itemDiv.appendChild(caret);  
      } else {  
        const spacer = document.createElement('span');  
        spacer.style.width = '16px';  
        spacer.style.flexShrink = '0';  
        itemDiv.appendChild(spacer);  
      }
        
      // Label  
      const label = document.createElement('span');  
      label.className = node.level === 1 ? 'tree-label bold' : 'tree-label';  
      label.textContent = `${node.name} (${node.structure})`;  
      itemDiv.appendChild(label);
  
      // Click handler for selection  
      itemDiv.addEventListener('click', () => {  
        // Clear previous selection  
        container.querySelectorAll('.tree-item.selected').forEach(item => {  
          item.classList.remove('selected');  
        });  
        itemDiv.classList.add('selected');
          
        if (selectionType === 'dataSource') {  
          selectedDataSourceId = node.id;  
          if (workflow === 'createReport') {  
            updateCreateReportDataSourceSummary();  
            if (createReportStep === 1) {  
              populateCreateReportTypes();  
            }  
          } else {  
            updateCustomExcelDataSourceSummary();  
            if (customExcelStep === 1) {  
              populateCustomExcelGroupingTypes();  
            }  
          }  
        } else {  
          selectedDestinationId = node.id;  
          updateCreateReportDestinationSummary();  
        }  
      });
        
      nodeDiv.appendChild(itemDiv);
        
      // Children  
      if (node.children && node.children.length > 0) {  
        const childrenDiv = document.createElement('div');  
        childrenDiv.className = `tree-children ${node.expanded ? 'expanded' : ''}`;
          
        node.children.forEach(child => {  
          renderTreeNode(child, childrenDiv, selectionType, workflow);  
        });
          
        nodeDiv.appendChild(childrenDiv);  
      }
        
      container.appendChild(nodeDiv);  
    }
  
    function toggleTreeNode(nodeDiv, caret) {  
      const childrenDiv = nodeDiv.querySelector('.tree-children');  
      if (childrenDiv) {  
        childrenDiv.classList.toggle('expanded');  
        caret.classList.toggle('expanded');  
      }  
    }
  
    function renderTree(container, selectionType = 'dataSource', workflow = 'createReport') {  
      container.innerHTML = '';  
      treeData.forEach(node => {  
        renderTreeNode(node, container, selectionType, workflow);  
      });  
    }
  
    // ===== Summary Updates =====  
    function getEngagementById(id) {  
      return consolidationMembers.find(e => e.id === id);  
    }
  
    function updateCreateReportDataSourceSummary() {  
      const eng = getEngagementById(selectedDataSourceId);  
      if (!eng) return;
  
      document.getElementById('cr-selectedDataSummary').innerHTML = `  
        <div><strong>Name:</strong> ${eng.name}</div>  
        <div><strong>Structure:</strong> ${eng.structure}</div>  
        <div><strong>Level:</strong> ${eng.level}</div>  
      `;
        
      document.getElementById('cr-prereqAccountGrouping').innerHTML = `‚Ä¢ Account Groupings: <span class="pill ${eng.hasAccountGroupings ? 'green' : 'red'}">${eng.hasAccountGroupings ? 'Available' : 'Not Set Up'}</span>`;  
      document.getElementById('cr-prereqTax').innerHTML = `‚Ä¢ Tax Setup: <span class="pill ${eng.hasTaxSetup ? 'green' : 'red'}">${eng.hasTaxSetup ? 'Complete' : 'Missing'}</span>`;  
    }
  
    function updateCustomExcelDataSourceSummary() {  
      const eng = getEngagementById(selectedDataSourceId);  
      if (!eng) return;
  
      document.getElementById('ce-selectedDataSummary').innerHTML = `  
        <div><strong>Name:</strong> ${eng.name}</div>  
        <div><strong>Structure:</strong> ${eng.structure}</div>  
        <div><strong>Level:</strong> ${eng.level}</div>  
      `;
        
      document.getElementById('ce-prereqAccountGrouping').innerHTML = `‚Ä¢ Account Groupings: <span class="pill ${eng.hasAccountGroupings ? 'green' : 'red'}">${eng.hasAccountGroupings ? 'Available' : 'Not Set Up'}</span>`;  
      document.getElementById('ce-prereqTax').innerHTML = `‚Ä¢ Tax Setup: <span class="pill ${eng.hasTaxSetup ? 'green' : 'red'}">${eng.hasTaxSetup ? 'Complete' : 'Missing'}</span>`;  
    }
  
    function updateCreateReportDestinationSummary() {  
      const eng = getEngagementById(selectedDestinationId);  
      if (!eng) return;
  
      document.getElementById('cr-selectedDestinationSummary').innerHTML = `  
        <div><strong>Name:</strong> ${eng.name}</div>  
        <div><strong>Structure:</strong> ${eng.structure}</div>  
        <div><strong>Level:</strong> ${eng.level}</div>  
      `;
        
      // Simulate permission check  
      const hasWriteAccess = Math.random() > 0.2; // 80% chance of access  
      document.getElementById('cr-destinationPermissions').innerHTML = `Write Access: <span class="pill ${hasWriteAccess ? 'green' : 'red'}">${hasWriteAccess ? 'Granted' : 'Denied'}</span>`;  
    }
  
    // ===== Report/Grouping Type Population =====  
    function populateCreateReportTypes() {  
      const eng = getEngagementById(selectedDataSourceId);  
      if (!eng) return;
  
      const dropdown = document.getElementById('cr-reportTypeDropdown');  
      const catalog = REPORT_CATALOG[eng.structure] || [];
  
      dropdown.innerHTML = '<option value="">Select report type...</option>';
  
      catalog.forEach(item => {  
        const gatedOut = (item.gatedBy === 'accountGrouping' && !eng.hasAccountGroupings)  
                      || (item.gatedBy === 'tax' && !eng.hasTaxSetup);
  
        if (!gatedOut) {  
          const option = document.createElement('option');  
          option.value = item.key;  
          option.textContent = item.label;  
          dropdown.appendChild(option);  
        }  
      });  
    }
  
    function populateCustomExcelGroupingTypes() {  
      const eng = getEngagementById(selectedDataSourceId);  
      if (!eng) return;
  
      const dropdown = document.getElementById('ce-groupingTypeDropdown');  
      dropdown.innerHTML = '<option value="">Select grouping type...</option>';
  
      CUSTOM_EXCEL_CATALOG.forEach(item => {  
        const gatedOut = (item.gatedBy === 'accountGrouping' && !eng.hasAccountGroupings)  
                      || (item.gatedBy === 'tax' && !eng.hasTaxSetup);
  
        if (!gatedOut) {  
          const option = document.createElement('option');  
          option.value = item.key;  
          option.textContent = item.label;  
          dropdown.appendChild(option);  
        }  
      });  
    }
  
    // ===== Step Management =====  
    function updateCreateReportStepDisplay() {  
      // Hide all sections  
      document.getElementById('cr-dataSourceSection').style.display = 'none';  
      document.getElementById('cr-reportTypeSection').style.display = 'none';  
      document.getElementById('cr-optionsSection').style.display = 'none';  
      document.getElementById('cr-saveDestinationSection').style.display = 'none';
  
      // Update step indicators  
      document.querySelectorAll('#createReportSteps .step').forEach((step, index) => {  
        step.classList.remove('active', 'completed');  
        if (index + 1 < createReportStep) {  
          step.classList.add('completed');  
        } else if (index + 1 === createReportStep) {  
          step.classList.add('active');  
        }  
      });
  
      // Show current section and update buttons  
      switch (createReportStep) {  
        case 1:  
          document.getElementById('cr-dataSourceSection').style.display = 'block';  
          crNext.textContent = 'Next ‚Üí';  
          crNext.disabled = false;  
          break;  
        case 2:  
          document.getElementById('cr-reportTypeSection').style.display = 'block';  
          crNext.textContent = 'Next ‚Üí';  
          crNext.disabled = !selectedReportKey;  
          break;  
        case 3:  
          document.getElementById('cr-optionsSection').style.display = 'block';  
          crNext.textContent = showDestinationSelector ? 'Next ‚Üí' : 'Create Report';  
          crNext.disabled = false;  
          break;  
        case 4:  
          document.getElementById('cr-saveDestinationSection').style.display = 'block';  
          crNext.textContent = 'Create Report';  
          crNext.disabled = false;  
          break;  
      }
  
      crBack.style.display = createReportStep > 1 ? 'inline-block' : 'none';  
    }
  
    function updateCustomExcelStepDisplay() {  
      // Hide all sections  
      document.getElementById('ce-dataSourceSection').style.display = 'none';  
      document.getElementById('ce-groupingTypeSection').style.display = 'none';  
      document.getElementById('ce-customizeOptionsSection').style.display = 'none';  
      document.getElementById('ce-customizeColumnsSection').style.display = 'none';  
      document.getElementById('ce-workpaperPropertiesSection').style.display = 'none';
  
      // Update step indicators  
      document.querySelectorAll('.wizard-step').forEach((step, index) => {  
        step.classList.remove('active', 'completed');  
        if (index + 1 < customExcelStep) {  
          step.classList.add('completed');  
        } else if (index + 1 === customExcelStep) {  
          step.classList.add('active');  
        }  
      });
  
      // Show current section and update buttons  
      switch (customExcelStep) {  
        case 1:  
          document.getElementById('ce-dataSourceSection').style.display = 'block';  
          ceNext.textContent = 'Next ‚Üí';  
          ceNext.disabled = false;  
          break;  
        case 2:  
          document.getElementById('ce-groupingTypeSection').style.display = 'block';  
          ceNext.textContent = 'Next ‚Üí';  
          ceNext.disabled = !selectedGroupingKey;  
          break;  
        case 3:  
          document.getElementById('ce-customizeOptionsSection').style.display = 'block';  
          ceNext.textContent = 'Next ‚Üí';  
          ceNext.disabled = false;  
          break;  
        case 4:  
          document.getElementById('ce-customizeColumnsSection').style.display = 'block';  
          ceNext.textContent = 'Next ‚Üí';  
          ceNext.disabled = false;  
          break;  
        case 5:  
          document.getElementById('ce-workpaperPropertiesSection').style.display = 'block';  
          ceNext.textContent = 'Create Workpaper';  
          ceNext.disabled = false;  
          break;  
      }
  
      ceBack.style.display = customExcelStep > 1 ? 'inline-block' : 'none';  
    }
  
    // ===== Modal Management =====  
    function openCreateReportModal() {  
      createReportStep = 1;  
      selectedReportKey = null;
        
      const isInGroup = currentEngagementContext.isInConsolidationGroup;
        
      if (!isInGroup) {  
        createReportStep = 2;  
        selectedDataSourceId = 'E-ROOT';  
      }
  
      renderTree(document.getElementById('cr-dataSourceTree'), 'dataSource', 'createReport');  
      updateCreateReportDataSourceSummary();  
      populateCreateReportTypes();  
      updateCreateReportStepDisplay();
  
      createReportBackdrop.style.display = 'flex';  
    }
  
    function closeCreateReportModal() {  
      createReportBackdrop.style.display = 'none';  
    }
  
    function openCustomExcelModal() {  
      customExcelStep = 1;  
      selectedGroupingKey = null;
        
      const isInGroup = currentEngagementContext.isInConsolidationGroup;
        
      if (!isInGroup) {  
        customExcelStep = 2;  
        selectedDataSourceId = 'E-ROOT';  
      }
  
      renderTree(document.getElementById('ce-dataSourceTree'), 'dataSource', 'customExcel');  
      updateCustomExcelDataSourceSummary();  
      populateCustomExcelGroupingTypes();  
      updateCustomExcelStepDisplay();
  
      customExcelBackdrop.style.display = 'flex';  
    }
  
    function closeCustomExcelModal() {  
      customExcelBackdrop.style.display = 'none';  
    }
  
    // ===== Event Listeners =====
      
    // Add dropdown  
    btnAdd.addEventListener('click', (e) => {  
      e.stopPropagation();  
      addDropdown.classList.toggle('show');  
    });
  
    addCustomExcel.addEventListener('click', () => {  
      addDropdown.classList.remove('show');  
      openCustomExcelModal();  
    });
  
    // Create Report  
    btnCreateReport.addEventListener('click', openCreateReportModal);  
    crClose.addEventListener('click', closeCreateReportModal);  
    crCancel.addEventListener('click', closeCreateReportModal);
  
    crNext.addEventListener('click', () => {  
      const maxStep = showDestinationSelector ? 4 : 3;
        
      if (createReportStep < maxStep) {  
        createReportStep++;  
        updateCreateReportStepDisplay();
          
        if (createReportStep === 2) {  
          populateCreateReportTypes();  
        } else if (createReportStep === 4) {  
          renderTree(document.getElementById('cr-saveDestinationTree'), 'destination', 'createReport');  
          updateCreateReportDestinationSummary();  
        }  
      } else {  
        const dataSource = getEngagementById(selectedDataSourceId);  
        const destination = getEngagementById(selectedDestinationId);  
        alert(`Creating report:
          
Data Source: ${dataSource.name} (${dataSource.structure})  
Report Type: ${selectedReportKey}  
Save Location: ${destination.name}
  
This would now proceed to generate the report with the selected options.`);  
        closeCreateReportModal();  
      }  
    });
  
    crBack.addEventListener('click', () => {  
      if (createReportStep > 1) {  
        createReportStep--;  
        updateCreateReportStepDisplay();  
      }  
    });
  
    // Custom Excel  
    ceBackToWorkpapers.addEventListener('click', closeCustomExcelModal);  
    ceCancel.addEventListener('click', closeCustomExcelModal);
  
    ceNext.addEventListener('click', () => {  
      if (customExcelStep < 5) {  
        customExcelStep++;  
        updateCustomExcelStepDisplay();
          
        if (customExcelStep === 2) {  
          populateCustomExcelGroupingTypes();  
        }  
      } else {  
        const dataSource = getEngagementById(selectedDataSourceId);  
        alert(`Creating Custom Excel workpaper:
          
Data Source: ${dataSource.name} (${dataSource.structure})  
Grouping Type: ${selectedGroupingKey}
  
This would now proceed to create the Custom Excel document with the selected options.`);  
        closeCustomExcelModal();  
      }  
    });
  
    ceBack.addEventListener('click', () => {  
      if (customExcelStep > 1) {  
        customExcelStep--;  
        updateCustomExcelStepDisplay();  
      }  
    });
  
    // Report type selection  
    document.getElementById('cr-reportTypeDropdown').addEventListener('change', (e) => {  
      selectedReportKey = e.target.value;  
      crNext.disabled = !selectedReportKey;  
    });
  
    // Grouping type selection  
    document.getElementById('ce-groupingTypeDropdown').addEventListener('change', (e) => {  
      selectedGroupingKey = e.target.value;  
      ceNext.disabled = !selectedGroupingKey;  
    });
  
    // Demo controls  
    toggleConsolidation.addEventListener('change', (e) => {  
      currentEngagementContext.isInConsolidationGroup = e.target.checked;  
      document.getElementById('isInGroupFlag').textContent = e.target.checked ? 'Yes' : 'No';  
    });
  
    toggleDestination.addEventListener('change', (e) => {  
      showDestinationSelector = e.target.checked;  
    });
  
    // Close dropdowns when clicking outside  
    document.addEventListener('click', (e) => {  
      if (!e.target.closest('.add-dropdown')) {  
        addDropdown.classList.remove('show');  
      }  
    });
  
    // Close modals when clicking backdrop  
    createReportBackdrop.addEventListener('click', (e) => {  
      if (e.target === createReportBackdrop) closeCreateReportModal();  
    });
  
    customExcelBackdrop.addEventListener('click', (e) => {  
      if (e.target === customExcelBackdrop) closeCustomExcelModal();  
    });
  
    // Initialize  
    updateCreateReportDataSourceSummary();  
    updateCustomExcelDataSourceSummary();  
    document.getElementById('currentEngagementName').textContent = currentEngagementContext.clientDisplay;  
    document.getElementById('isInGroupFlag').textContent = currentEngagementContext.isInConsolidationGroup ? 'Yes' : 'No';  
  </script>  
</body>  

</html>  
