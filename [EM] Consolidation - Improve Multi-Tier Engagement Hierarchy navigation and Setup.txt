Epic 4237546: [EM] Consolidation - Improve Multi-Tier Engagement Hierarchy navigation and Setup.

Feature 4237550: Comprehensive Hierarchy Navigation and Direct Access

- 4484384: User Story 1.1 - Design and Implement Multi-Level Consolidation Tree Database Structure
- 4484386: User Story 1.2 - Create API Service Layer for Consolidation Tree Operations
- 4484388: User Story 1.3 - Create API Endpoints for Consolidation Tree Navigation
- 4484390: User Story 1.4 - Remove Consolidated Navigation Arrows and Go to Parent Button (FE)
- 4484391: User Story 1.5 - Separate Consolidated into Independent Dropdown Menu
- 4484392: User Story 1.6 - Display Consolidated Menu for Any Engagement in Consolidation Tree
- 4484393: User Story 1.7 - Implement Nested Tree Structure in Consolidated Dropdown
- 4484394: User Story 1.8 - Update Engagement Dropdown to Show Expandable Client List
- 4495189: Design Story - [CAS] EM: Consolidated Breadcrumb
- 4495261: User Story - Block deletion of child engagements and display direct parent in error (hierarchy regression)

Feature 4381620: Multi-Tier Hierarchy Configuration in Engagement Setup

- 4439355: User Story - [Consol] [Multi tier] - Identify engagements with multiple parents and measure multi-tier depth
- 4484395: User Story 2.1 - Create Consolidation Setup Screen with Tree Table View
- 4484396: User Story 2.2 - Implement Add Engagement Functionality with Consolidation Merge Support
- 4484397: User Story 2.3 - Implement Change Parent Functionality with Tree Visualization
- 4484398: User Story 2.4 - Implement Move Up/Down Functionality
- 4484399: User Story 2.5 - Implement Delete Functionality with Children Handling and Consolidation Split
- 4484401: User Story 2.6 - Implement Save Functionality and Change Tracking
- 4484402: User Story 2.7 - Display Tree Levels in Table with Visual Indicators
- 4484403: User Story 2.8 - Add API Endpoint for Consolidation Merge Validation
- 4484407: User Story 2.9 - Add API Endpoint for Consolidation Split Operation
- 4484414: User Story 2.10 - Update Add Engagement Dialog to Show Merge Preview
- 4495120: Design Story - [CAS] EM: Consolidated Engagement Setup
- 4495263: User Story - Deleting a ROOT engagement promotes direct children to ROOT and splits binders

Feature 4485253: Multi-Level Consolidation Change Detection and Staged Reconsolidation

- 4485245: Story 1 - Multi-level change detection and ancestor propagation
- 4485246: Story 2 - Debounced bottom-up reconsolidation orchestrator
- 4485247: Story 3 - Consolidation status and pending endpoints
- 4485248: Story 4 - Bottom-up reconsolidation engine
- 4485249: Story 5 - Manual consolidation triggers
- 4485250: Story 6 - Multi-level banners and progress UI
- 4485251: Story 7 - Permissions and audit trail for consolidations
- 4485252: Story 8 - Resilience patterns, telemetry, and comprehensive tests


# Feature 1: Comprehensive Hierarchy Navigation and Direct Access

## User Story 1.1: Design and Implement Multi-Level Consolidation Tree Database Structure (ADO 4484384)

As a system architect  
I want to design a database structure that supports multi-level consolidation hierarchies  
so that the application can traverse and display the entire consolidation tree regardless of depth

Problem Statement:
The current database structure only supports one-level parent-child relationships (each engagement knows its immediate parent, but not its position in the overall hierarchy). To display a complete consolidation tree and enable navigation across all levels, we need a database structure that can store and efficiently query the entire hierarchy.

Description:
Design and implement a new database structure that captures the complete consolidation tree, including all ancestor-descendant relationships, levels, and hierarchy paths. This will enable the application to query the full tree structure for any engagement node.

Acceptance Criteria:
- Database Schema Design:
  - New table: ConsolidationHierarchy with Id (PK), EngagementId (FK), ParentEngagementId (nullable FK), Level (int), Path (varchar), RootEngagementId (FK), DisplayOrder (int), CreatedBy/CreatedDate/ModifiedBy/ModifiedDate
  - Indexes on EngagementId, ParentEngagementId, RootEngagementId, Path; composite on (RootEngagementId, Level, DisplayOrder)
  - Constraints to prevent invalid levels and ensure root semantics
- Hierarchical Path Storage:
  - Path stores full hierarchy like “/1/5/12/45”, supports ancestor/descendant queries, auto-maintained
- Tree Traversal Support:
  - Stored procs: sp_GetConsolidationTree, sp_GetAncestors, sp_GetDescendants, sp_GetSiblings, sp_GetTreeDepth; fn_IsPartOfConsolidation
- Data Integrity:
  - Triggers prevent cycles, orphans; auto-update path/level/root on moves; cascade updates to descendants
- Migration Strategy:
  - Scripts to create schema, migrate existing relationships, compute Level/Path/RootEngagementId/DisplayOrder; rollback and validation
- Performance:
  - Query SLAs (<100ms typical), caching strategy, optimized plans
- Documentation:
  - ERD, stored proc docs, query patterns, migration plan, benchmarks
- Testing:
  - Unit, integration, performance, integrity, concurrency, boundary scenarios


## User Story 1.2: Create API Service Layer for Consolidation Tree Operations (ADO 4484386)
… unchanged from prior content, aligned to ID above …


## User Story 1.3: Create API Endpoints for Consolidation Tree Navigation (ADO 4484388)
… unchanged from prior content, aligned to ID above …


## User Story 1.4: Remove Consolidated Navigation Arrows and Go to Parent Button (FE) (ADO 4484390)
… unchanged …


## User Story 1.5: Separate Consolidated into Independent Dropdown Menu (ADO 4484391)
… unchanged …


## User Story 1.6: Display Consolidated Menu for Any Engagement in Consolidation Tree (ADO 4484392)
… unchanged …


## User Story 1.7: Implement Nested Tree Structure in Consolidated Dropdown (ADO 4484393)
… unchanged …


## User Story 1.8: Update Engagement Dropdown to Show Expandable Client List (ADO 4484394)
… unchanged …


## Design Story: [CAS] EM: Consolidated Breadcrumb (ADO 4495189)
… design reference …


## User Story: Block deletion of child engagements and display direct parent in error (hierarchy regression) (ADO 4495261)
… description and acceptance criteria per ADO …


# Feature 2: Multi-Tier Hierarchy Configuration in Engagement Setup

## User Story 2.1: Create Consolidation Setup Screen with Tree Table View (ADO 4484395)
… unchanged …


## User Story 2.2: Implement Add Engagement Functionality with Consolidation Merge Support (ADO 4484396)
Consolidation Merge Logic additions (retains full content):
- When adding an engagement that is already a consolidated root:
  - Detect and merge entire subtree; recalc Level/Path/RootEngagementId; assign DisplayOrder; retire source consolidation (no soft delete)
- When adding a standalone engagement:
  - Add as single node

… remaining content unchanged …


## User Story 2.3: Implement Change Parent Functionality with Tree Visualization (ADO 4484397)
… unchanged …


## User Story 2.4: Implement Move Up/Down Functionality (ADO 4484398)
… unchanged …


## User Story 2.5: Implement Delete Functionality with Children Handling and Consolidation Split (ADO 4484399)
… unchanged …


## User Story 2.6: Implement Save Functionality and Change Tracking (ADO 4484401)
Save Success addition:
- On successful save, disable Save, reset tracking, and if merge occurred, retire source consolidation (no soft delete); if split occurred, create new consolidation record

… remaining content unchanged …


## User Story 2.7: Display Tree Levels in Table with Visual Indicators (ADO 4484402)
… unchanged …


## User Story 2.8: Add API Endpoint for Consolidation Merge Validation (ADO 4484403)
Warning Messages additions:
- “Merge will add [X] engagements…”
- “Source consolidation will be retired…”
- “Resulting tree will have [X] levels”

… remaining content unchanged …


## User Story 2.9: Add API Endpoint for Consolidation Split Operation (ADO 4484407)
… unchanged …


## User Story 2.10: Update Add Engagement Dialog to Show Merge Preview (ADO 4484414)
… unchanged …


## Design Story: [CAS] EM: Consolidated Engagement Setup (ADO 4495120)
… design reference …


## User Story: Deleting a ROOT engagement promotes direct children to ROOT and splits binders (ADO 4495263)
… description and acceptance criteria per ADO …


# Feature 3: Multi-Level Consolidation Change Detection and Staged Reconsolidation

## Story 1: Multi-level change detection and ancestor propagation (ADO 4485245)
… unchanged …


## Story 2: Debounced bottom-up reconsolidation orchestrator (ADO 4485246)
… unchanged …


## Story 3: Consolidation status and pending endpoints (ADO 4485247)
… unchanged …


## Story 4: Bottom-up reconsolidation engine (ADO 4485248)
… unchanged …


## Story 5: Manual consolidation triggers (ADO 4485249)
… unchanged …


## Story 6: Multi-level banners and progress UI (ADO 4485250)
… unchanged …


## Story 7: Permissions and audit trail for consolidations (ADO 4485251)
… unchanged …


## Story 8: Resilience patterns, telemetry, and comprehensive tests (ADO 4485252)
… unchanged …
