name: Merge ADO CSVs

on:
  workflow_dispatch:
  push:
    branches: [ data/ado-merge-actions ]

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate merged CSV
        run: |
          python - << 'PY'
          import csv
          from pathlib import Path

          INPUT_DIR = Path('.')
          SRC_FILE = INPUT_DIR / 'Accessibility issues flat list (3).csv'
          if not SRC_FILE.exists():
              SRC_FILE = INPUT_DIR / 'Accessibility issues flat list.csv'
          ATTR_FILE = INPUT_DIR / 'ado-bulk-update-with-sp-import.csv'
          if not ATTR_FILE.exists():
              ATTR_FILE = INPUT_DIR / 'ado-bulk-update-with-sp.csv'
          OUT_FILE = Path('merged') / 'ado-merged.csv'

          OUT_HEADERS = [
              'ID',
              'Title',
              'Work Item Type',
              'System.AreaPath',
              'System.IterationPath',
              'Microsoft.VSTS.Common.Priority',
              'Microsoft.VSTS.Scheduling.StoryPoints',
          ]

          def clean(v):
              if v is None:
                  return ''
              s = str(v).strip()
              return '' if s.lower() == 'nan' else s

          def norm_sp(v):
              s = clean(v)
              if s == '':
                  return ''
              try:
                  f = float(s)
                  return str(int(f)) if f.is_integer() else s
              except Exception:
                  return ''

          def load_src(path):
              rows = {}
              with open(path, newline='', encoding='utf-8-sig') as f:
                  r = csv.DictReader(f)
                  for row in r:
                      idv = clean(row.get('ID'))
                      if not idv:
                          continue
                      rows[idv] = {
                          'ID': idv,
                          'Title': clean(row.get('Title')),
                          'Work Item Type': clean(row.get('Work Item Type')),
                      }
              return rows

          def load_attr(path):
              rows = {}
              with open(path, newline='', encoding='utf-8-sig') as f:
                  # handle the pasted key:value format as well as CSV
                  header = f.readline()
                  f.seek(0)
                  sample = header.strip()
                  if sample and ':' in sample and ',' in sample and 'ID:' in sample:
                      # parse custom key:value lines
                      for line in f:
                          line=line.strip()
                          if not line:
                              continue
                          parts = [p.strip() for p in line.split(',')]
                          kv = {}
                          for p in parts:
                              if ':' in p:
                                  k, v = p.split(':', 1)
                                  kv[k.strip()] = v.strip()
                          idv = clean(kv.get('ID'))
                          if not idv:
                              continue
                          rows[idv] = {
                              'System.AreaPath': clean(kv.get('System.AreaPath')),
                              'System.IterationPath': clean(kv.get('System.IterationPath')),
                              'Microsoft.VSTS.Common.Priority': clean(kv.get('Microsoft.VSTS.Common.Priority')),
                              'Microsoft.VSTS.Scheduling.StoryPoints': norm_sp(kv.get('Microsoft.VSTS.Scheduling.StoryPoints')),
                          }
                  else:
                      r = csv.DictReader(f)
                      for row in r:
                          idv = clean(row.get('ID'))
                          if not idv:
                              continue
                          rows[idv] = {
                              'System.AreaPath': clean(row.get('System.AreaPath')),
                              'System.IterationPath': clean(row.get('System.IterationPath')),
                              'Microsoft.VSTS.Common.Priority': clean(row.get('Microsoft.VSTS.Common.Priority')),
                              'Microsoft.VSTS.Scheduling.StoryPoints': norm_sp(row.get('Microsoft.VSTS.Scheduling.StoryPoints')),
                          }
              return rows

          src = load_src(SRC_FILE)
          attrs = load_attr(ATTR_FILE)

          OUT_FILE.parent.mkdir(parents=True, exist_ok=True)
          with open(OUT_FILE, 'w', newline='', encoding='utf-8') as f:
              w = csv.DictWriter(f, fieldnames=OUT_HEADERS, quoting=csv.QUOTE_MINIMAL)
              w.writeheader()
              for idv, s in src.items():
                  a = attrs.get(idv, {})
                  row = {
                      'ID': s['ID'],
                      'Title': s['Title'],
                      'Work Item Type': s['Work Item Type'],
                      'System.AreaPath': a.get('System.AreaPath', ''),
                      'System.IterationPath': a.get('System.IterationPath', ''),
                      'Microsoft.VSTS.Common.Priority': a.get('Microsoft.VSTS.Common.Priority', ''),
                      'Microsoft.VSTS.Scheduling.StoryPoints': a.get('Microsoft.VSTS.Scheduling.StoryPoints', ''),
                  }
                  # final clean pass
                  for k, v in row.items():
                      row[k] = clean(v)
                  w.writerow(row)

          # Validate 7 columns per row
          with open(OUT_FILE, 'r', encoding='utf-8') as f:
              for i, line in enumerate(f, start=1):
                  pass
          PY

      - name: Commit merged CSV
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add merged/ado-merged.csv
            git commit -m "Generate import-safe merged CSV"
            git push
          else
            echo "No changes to commit"
          fi
