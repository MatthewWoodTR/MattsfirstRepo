<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidation Setup - Engagement Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }

        /* Header */
        .header {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 56px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 32px;
            height: 32px;
            background-color: #ff6600;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 400;
            color: #333;
        }

        .app-subtitle {
            color: #ff6600;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .header-icon {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #666;
        }

        .header-icon:hover {
            background-color: #f5f5f5;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
            margin-top: 56px;
        }

        /* Left Navigation */
        .left-nav {
            width: 220px;
            background-color: #fff;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .engagement-info {
            padding: 16px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #0066cc;
            color: white;
        }

        .engagement-number {
            font-size: 12px;
            opacity: 0.9;
        }

        .engagement-name {
            font-size: 14px;
            font-weight: 600;
            margin-top: 4px;
        }

        .nav-menu {
            list-style: none;
            padding: 8px 0;
        }

        .nav-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #333;
            font-size: 14px;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: #f5f5f5;
        }

        .nav-item.active {
            background-color: #e6f2ff;
            border-left-color: #0066cc;
            color: #0066cc;
            font-weight: 600;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
        }

        /* Breadcrumb */
        .breadcrumb-container {
            background-color: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb-button {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }

        .breadcrumb-button:hover {
            background-color: #e6f2ff;
        }

        .breadcrumb-separator {
            color: #999;
        }

        .breadcrumb-text {
            color: #333;
            font-weight: 500;
        }

        .back-arrow {
            color: #0066cc;
            cursor: pointer;
            padding: 6px;
            margin-right: 12px;
            font-size: 18px;
        }

        .back-arrow:hover {
            background-color: #e6f2ff;
            border-radius: 4px;
        }

        /* Page Title */
        .page-title-section {
            background-color: white;
            padding: 16px 24px;
            border-bottom: 2px solid #ff6600;
        }

        .page-title {
            font-size: 24px;
            font-weight: 400;
            color: #333;
        }

        /* Consolidation Content */
        .consolidation-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow: hidden;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .toolbar-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s;
        }

        .toolbar-button:hover:not(:disabled) {
            background-color: #f5f5f5;
        }

        .toolbar-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toolbar-button-icon {
            font-size: 16px;
        }

        /* Table Container */
        .table-container {
            flex: 1;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: auto;
            margin-bottom: 24px;
            min-height: 200px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            background-color: #f9f9f9;
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            font-size: 13px;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            color: #333;
        }

        tbody tr {
            cursor: pointer;
            transition: background-color 0.1s;
        }

        tbody tr:hover {
            background-color: #f5f5f5;
        }

        tbody tr.selected {
            background-color: #e6f2ff;
            border-left: 3px solid #0066cc;
        }

        /* Tree Structure in Table */
        .tree-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            color: #666;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-spacer {
            width: 16px;
            flex-shrink: 0;
        }

        .structure-badge {
            padding: 2px 8px;
            background-color: #e0e0e0;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            flex-shrink: 0;
        }

        .structure-consolidated {
            background-color: #cce5ff;
            color: #0066cc;
        }

        .structure-none {
            background-color: #f0f0f0;
            color: #999;
        }

        /* Options Section */
        .options-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .options-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }

        .options-title-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .options-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .options-subtitle {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .options-subtitle strong {
            color: #0066cc;
            font-weight: 600;
        }

        .consolidated-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background-color: #e6f2ff;
            border: 1px solid #0066cc;
            border-radius: 4px;
            font-size: 12px;
            color: #0066cc;
            font-weight: 600;
        }

        .consolidated-indicator-icon {
            font-size: 14px;
        }

        .option-group {
            margin-bottom: 16px;
        }

        .option-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
        }

        .option-dropdown {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .option-dropdown:focus {
            outline: none;
            border-color: #0066cc;
        }

        .option-dropdown:disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 14px;
            color: #333;
            cursor: pointer;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #4a4a4a;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #333;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #d0d0d0;
        }

        /* Modal/Dialog */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background-color: #f5f5f5;
            color: #333;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #d32f2f;
            margin-left: 4px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .current-parent-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* Tree Selector Component */
        .tree-selector {
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
        }

        .tree-node {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .tree-node:hover:not(.disabled) {
            background-color: #f5f5f5;
        }

        .tree-node.selected {
            background-color: #e6f2ff;
            border-left: 3px solid #0066cc;
        }

        .tree-node.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #fafafa;
        }

        .tree-node.current {
            background-color: #fff3cd;
        }

        .tree-node-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            flex-shrink: 0;
        }

        .tree-node-label {
            flex: 1;
            font-size: 14px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 80px;
            right: 24px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            min-width: 300px;
            border-left: 4px solid #4caf50;
        }

        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        .toast.error {
            border-left-color: #d32f2f;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Delete Dialog Specific */
        .warning-icon {
            color: #ff9800;
            font-size: 48px;
            text-align: center;
            margin-bottom: 16px;
        }

        .delete-message {
            font-size: 15px;
            color: #333;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .delete-warning {
            background-color: #fff3cd;
            padding: 12px;
            border-radius: 4px;
            border-left: 4px solid #ff9800;
            margin-bottom: 16px;
        }

        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b71c1c;
        }

        /* Options No Selection State */
        .options-no-selection {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .options-no-selection-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .options-no-selection-text {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-section">
            <div class="logo">TR</div>
            <div class="app-title">
                Thomson Reuters <span class="app-subtitle">Engagement Manager</span>
            </div>
        </div>
        <div class="header-actions">
            <div class="header-icon" title="Settings">‚öô</div>
            <div class="header-icon" title="Help">?</div>
            <div class="header-icon" title="Notifications">üîî</div>
            <div class="header-icon" title="Apps">‚äû</div>
            <div class="header-icon" title="Profile">üë§</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Navigation -->
        <div class="left-nav">
            <div class="engagement-info">
                <div class="engagement-number">1984</div>
                <div class="engagement-name">053B2 - TEST CLIENT</div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <span class="nav-icon">üìä</span>
                    <span>Status</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">üìÅ</span>
                    <span>Workpapers</span>
                </li>
                <li class="nav-item active">
                    <span class="nav-icon">‚öñ</span>
                    <span>Trial balance</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">üìù</span>
                    <span>Journal entries</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">üìã</span>
                    <span>Notes list</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">üë•</span>
                    <span>Communications</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">üìà</span>
                    <span>Analyze</span>
                </li>
                <li class="nav-item">
                    <span class="nav-icon">üß™</span>
                    <span>Test</span>
                </li>
            </ul>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Breadcrumb -->
            <div class="breadcrumb-container">
                <div class="breadcrumb">
                    <span class="back-arrow" onclick="goBack()">‚Üê</span>
                    <div class="breadcrumb-item">
                        <button class="breadcrumb-button">Home</button>
                    </div>
                    <span class="breadcrumb-separator">/</span>
                    <div class="breadcrumb-item">
                        <span class="breadcrumb-text">1984 - 053B2 - TEST CLIENT</span>
                    </div>
                    <span class="breadcrumb-separator">/</span>
                    <div class="breadcrumb-item">
                        <button class="breadcrumb-button">
                            Consolidated 5/31 RF (12/31/2025) Consolidated ‚ñº
                        </button>
                    </div>
                </div>
            </div>

            <!-- Page Title -->
            <div class="page-title-section">
                <h1 class="page-title">Consolidation</h1>
            </div>

            <!-- Consolidation Content -->
            <div class="consolidation-content">
                <!-- Toolbar -->
                <div class="toolbar">
                    <button class="toolbar-button" id="addEngagementBtn" onclick="openAddDialog()">
                        <span class="toolbar-button-icon">‚äï</span>
                        <span>Add engagement</span>
                    </button>
                    <button class="toolbar-button" id="changeParentBtn" onclick="openChangeParentDialog()" disabled>
                        <span class="toolbar-button-icon">‚§¥</span>
                        <span>Change Parent</span>
                    </button>
                    <button class="toolbar-button" id="moveUpBtn" onclick="moveUp()" disabled>
                        <span class="toolbar-button-icon">‚Üë</span>
                        <span>Move up</span>
                    </button>
                    <button class="toolbar-button" id="moveDownBtn" onclick="moveDown()" disabled>
                        <span class="toolbar-button-icon">‚Üì</span>
                        <span>Move down</span>
                    </button>
                    <button class="toolbar-button" id="deleteBtn" onclick="openDeleteDialog()" disabled>
                        <span class="toolbar-button-icon">üóë</span>
                        <span>Delete</span>
                    </button>
                </div>

                <!-- Table -->
                <div class="table-container">
                    <table id="consolidationTable">
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Structure</th>
                                <th>Balance</th>
                                <th>Client Name</th>
                                <th>Client Number</th>
                                <th>Engagement name</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Options Section -->
                <div class="options-section" id="optionsSection">
                    <!-- Content populated dynamically based on selection -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Engagement Dialog -->
    <div class="modal-overlay" id="addEngagementModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Engagement to Consolidation</h2>
                <button class="modal-close" onclick="closeAddDialog()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Client<span class="required">*</span></label>
                    <select class="form-control" id="clientSelect" onchange="onClientChange()">
                        <option value="">Choose a client...</option>
                        <!-- Populated by JavaScript -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Engagement<span class="required">*</span></label>
                    <select class="form-control" id="engagementSelect" disabled onchange="onEngagementChange()">
                        <option value="">Choose an engagement...</option>
                        <!-- Populated by JavaScript based on client selection -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Balance type<span class="required">*</span></label>
                    <select class="form-control" id="balanceTypeSelect" disabled>
                        <option value="">Choose balance type...</option>
                        <!-- Populated dynamically based on structure type -->
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Label<span class="required">*</span></label>
                    <input type="text" class="form-control" id="labelInput" placeholder="Enter label" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddDialog()">Cancel</button>
                <button class="btn btn-primary" onclick="addEngagement()">Add</button>
            </div>
        </div>
    </div>

    <!-- Change Parent Dialog -->
    <div class="modal-overlay" id="changeParentModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="changeParentTitle">Change Parent</h2>
                <button class="modal-close" onclick="closeChangeParentDialog()">√ó</button>
            </div>
            <div class="modal-body">
                <p class="current-parent-text" id="currentParentText">Current parent: Root</p>

                <div class="form-group">
                    <label class="form-label">Select New Parent</label>
                    <div class="tree-selector" id="changeParentTreeSelector">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeChangeParentDialog()">Cancel</button>
                <button class="btn btn-primary" id="saveParentBtn" onclick="saveParentChange()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Dialog -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Remove from Consolidation?</h2>
                <button class="modal-close" onclick="closeDeleteDialog()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="warning-icon">‚ö†</div>
                <div class="delete-message" id="deleteMessage">
                    Are you sure you want to remove <strong id="deleteEngagementName"></strong> from this consolidation?
                </div>
                <div class="delete-warning" id="deleteWarning" style="display: none;">
                    This engagement has <strong id="childCount"></strong> child engagement(s). All child engagements will also be removed.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteDialog()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Remove</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">‚úì</span>
        <span class="toast-message" id="toastMessage"></span>
    </div>

    <script>
        // Mock data for available clients and their engagements
        const availableClients = [
            {
                id: 'client1',
                clientNumber: '1984',
                clientName: '053B2 - TEST CLIENT',
                engagements: [
                    { id: 'eng1', name: 'Annual Audit 2024', date: '12/31/2024', structure: 'Consolidated' },
                    { id: 'eng2', name: 'Review 2024', date: '06/30/2024', structure: 'None' },
                    { id: 'eng3', name: 'Compilation 2024', date: '03/31/2024', structure: 'None' }
                ]
            },
            {
                id: 'client2',
                clientNumber: '238622-56',
                clientName: 'EBK-AB',
                engagements: [
                    { id: 'eng4', name: 'Year End Audit', date: '12/31/2024', structure: 'Consolidated' },
                    { id: 'eng5', name: 'Tax Return', date: '12/31/2024', structure: 'None' }
                ]
            },
            {
                id: 'client3',
                clientNumber: '360810-2532',
                clientName: '3M COMPANY',
                engagements: [
                    { id: 'eng6', name: 'Financial Audit', date: '12/31/2024', structure: 'Consolidated' },
                    { id: 'eng7', name: 'Quarterly Review Q3', date: '09/30/2024', structure: 'None' }
                ]
            }
        ];

        // Balance type options
        const balanceTypesNone = ['Unadjusted', 'Adjusted', 'Report', 'Federal Tax', 'State Tax', 'Other', 'Other 2', 'Other 3'];
        const balanceTypesConsolidated = ['Total', 'Final', 'Federal Tax', 'State Tax', 'Other', 'Other 2', 'Other 3'];

        // Mock engagement setup data (for determining Consolidate By options)
        const engagementSetupData = {
            1: { hasAccountGroupings: true, hasTaxSetup: true },
            2: { hasAccountGroupings: true, hasTaxSetup: false },
            3: { hasAccountGroupings: false, hasTaxSetup: true },
        };

        // Simplified 5-level hierarchy with 3 nodes at level 2, 2 at levels 3-5
        // FIXED: No more duplicate generation
        let consolidationData = [
            // Level 1 - Root
            {
                id: 1,
                label: 'Global Consolidated',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: '053B2 - TEST CLIENT',
                clientNumber: '1984',
                engagementName: 'Global Consolidated Group',
                parentId: null,
                level: 1,
                displayOrder: 1,
                children: []
            },
            // Level 2 - 3 nodes
            {
                id: 2,
                label: 'North America Division',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'NA Client',
                clientNumber: '1984',
                engagementName: 'NA Division Engagement',
                parentId: 1,
                level: 2,
                displayOrder: 1,
                children: []
            },
            {
                id: 3,
                label: 'Europe Division',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'EU Client',
                clientNumber: '1984',
                engagementName: 'Europe Division Engagement',
                parentId: 1,
                level: 2,
                displayOrder: 2,
                children: []
            },
            {
                id: 4,
                label: 'Asia Pacific Division',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'APAC Client',
                clientNumber: '1984',
                engagementName: 'APAC Division Engagement',
                parentId: 1,
                level: 2,
                displayOrder: 3,
                children: []
            },
            // Level 3 - 2 nodes per Level 2 parent
            {
                id: 5,
                label: 'US Operations',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'US Client',
                clientNumber: '1984',
                engagementName: 'US Operations Engagement',
                parentId: 2,
                level: 3,
                displayOrder: 1,
                children: []
            },
            {
                id: 6,
                label: 'Canada Operations',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'CA Client',
                clientNumber: '1984',
                engagementName: 'Canada Operations Engagement',
                parentId: 2,
                level: 3,
                displayOrder: 2,
                children: []
            },
            {
                id: 7,
                label: 'UK Operations',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'UK Client',
                clientNumber: '1984',
                engagementName: 'UK Operations Engagement',
                parentId: 3,
                level: 3,
                displayOrder: 1,
                children: []
            },
            {
                id: 8,
                label: 'Germany Operations',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'DE Client',
                clientNumber: '1984',
                engagementName: 'Germany Operations Engagement',
                parentId: 3,
                level: 3,
                displayOrder: 2,
                children: []
            },
            {
                id: 9,
                label: 'Japan Operations',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'JP Client',
                clientNumber: '1984',
                engagementName: 'Japan Operations Engagement',
                parentId: 4,
                level: 3,
                displayOrder: 1,
                children: []
            },
            {
                id: 10,
                label: 'Australia Operations',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'AU Client',
                clientNumber: '1984',
                engagementName: 'Australia Operations Engagement',
                parentId: 4,
                level: 3,
                displayOrder: 2,
                children: []
            },
            // Level 4 - 2 nodes per Level 3 parent
            {
                id: 11,
                label: 'US East Region',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'US East Client',
                clientNumber: '1984',
                engagementName: 'US East Region Engagement',
                parentId: 5,
                level: 4,
                displayOrder: 1,
                children: []
            },
            {
                id: 12,
                label: 'US West Region',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'US West Client',
                clientNumber: '1984',
                engagementName: 'US West Region Engagement',
                parentId: 5,
                level: 4,
                displayOrder: 2,
                children: []
            },
            {
                id: 13,
                label: 'Ontario Region',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'ON Client',
                clientNumber: '1984',
                engagementName: 'Ontario Region Engagement',
                parentId: 6,
                level: 4,
                displayOrder: 1,
                children: []
            },
            {
                id: 14,
                label: 'Quebec Region',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'QC Client',
                clientNumber: '1984',
                engagementName: 'Quebec Region Engagement',
                parentId: 6,
                level: 4,
                displayOrder: 2,
                children: []
            },
            {
                id: 15,
                label: 'London Region',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'London Client',
                clientNumber: '1984',
                engagementName: 'London Region Engagement',
                parentId: 7,
                level: 4,
                displayOrder: 1,
                children: []
            },
            {
                id: 16,
                label: 'Manchester Region',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Manchester Client',
                clientNumber: '1984',
                engagementName: 'Manchester Region Engagement',
                parentId: 7,
                level: 4,
                displayOrder: 2,
                children: []
            },
            {
                id: 17,
                label: 'Berlin Region',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'Berlin Client',
                clientNumber: '1984',
                engagementName: 'Berlin Region Engagement',
                parentId: 8,
                level: 4,
                displayOrder: 1,
                children: []
            },
            {
                id: 18,
                label: 'Munich Region',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Munich Client',
                clientNumber: '1984',
                engagementName: 'Munich Region Engagement',
                parentId: 8,
                level: 4,
                displayOrder: 2,
                children: []
            },
            {
                id: 19,
                label: 'Tokyo Region',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'Tokyo Client',
                clientNumber: '1984',
                engagementName: 'Tokyo Region Engagement',
                parentId: 9,
                level: 4,
                displayOrder: 1,
                children: []
            },
            {
                id: 20,
                label: 'Osaka Region',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Osaka Client',
                clientNumber: '1984',
                engagementName: 'Osaka Region Engagement',
                parentId: 9,
                level: 4,
                displayOrder: 2,
                children: []
            },
            {
                id: 21,
                label: 'Sydney Region',
                structure: 'Consolidated',
                balance: 'Total',
                clientName: 'Sydney Client',
                clientNumber: '1984',
                engagementName: 'Sydney Region Engagement',
                parentId: 10,
                level: 4,
                displayOrder: 1,
                children: []
            },
            {
                id: 22,
                label: 'Melbourne Region',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Melbourne Client',
                clientNumber: '1984',
                engagementName: 'Melbourne Region Engagement',
                parentId: 10,
                level: 4,
                displayOrder: 2,
                children: []
            },
            // Level 5 - 2 leaf engagements per Level 4 parent
            {
                id: 23,
                label: 'US East Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 23',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 23',
                parentId: 11,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 24,
                label: 'US East Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 24',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 24',
                parentId: 11,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 25,
                label: 'US West Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 25',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 25',
                parentId: 12,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 26,
                label: 'US West Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 26',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 26',
                parentId: 12,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 27,
                label: 'Ontario Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 27',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 27',
                parentId: 13,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 28,
                label: 'Ontario Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 28',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 28',
                parentId: 13,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 29,
                label: 'Quebec Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 29',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 29',
                parentId: 14,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 30,
                label: 'Quebec Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 30',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 30',
                parentId: 14,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 31,
                label: 'London Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 31',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 31',
                parentId: 15,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 32,
                label: 'London Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 32',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 32',
                parentId: 15,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 33,
                label: 'Manchester Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 33',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 33',
                parentId: 16,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 34,
                label: 'Manchester Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 34',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 34',
                parentId: 16,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 35,
                label: 'Berlin Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 35',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 35',
                parentId: 17,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 36,
                label: 'Berlin Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 36',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 36',
                parentId: 17,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 37,
                label: 'Munich Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 37',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 37',
                parentId: 18,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 38,
                label: 'Munich Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 38',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 38',
                parentId: 18,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 39,
                label: 'Tokyo Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 39',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 39',
                parentId: 19,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 40,
                label: 'Tokyo Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 40',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 40',
                parentId: 19,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 41,
                label: 'Osaka Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 41',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 41',
                parentId: 20,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 42,
                label: 'Osaka Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 42',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 42',
                parentId: 20,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 43,
                label: 'Sydney Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 43',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 43',
                parentId: 21,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 44,
                label: 'Sydney Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 44',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 44',
                parentId: 21,
                level: 5,
                displayOrder: 2,
                children: []
            },
            {
                id: 45,
                label: 'Melbourne Subsidiary 1',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 45',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 45',
                parentId: 22,
                level: 5,
                displayOrder: 1,
                children: []
            },
            {
                id: 46,
                label: 'Melbourne Subsidiary 2',
                structure: 'None',
                balance: 'Adjusted',
                clientName: 'Client 46',
                clientNumber: '1984',
                engagementName: 'Leaf Engagement 46',
                parentId: 22,
                level: 5,
                displayOrder: 2,
                children: []
            }
        ];

        let selectedRowId = null;
        let unsavedChanges = false;
        let expandedNodes = new Set();
        let selectedNewParentId = null;
        
        // Build children arrays based on parentId relationships
        function buildChildrenArrays() {
            // Clear all children arrays first
            consolidationData.forEach(node => {
                node.children = [];
            });
            
            // Build children arrays by finding all nodes with matching parentId
            consolidationData.forEach(node => {
                if (node.parentId !== null) {
                    const parent = consolidationData.find(n => n.id === node.parentId);
                    if (parent && !parent.children.includes(node.id)) {
                        parent.children.push(node.id);
                    }
                }
            });
        }

        // Initialize
        function init() {
            // Build children arrays from parent relationships
            buildChildrenArrays();
            
            // Expand all nodes that have children
            consolidationData.forEach(node => {
                if (node.children && node.children.length > 0) {
                    expandedNodes.add(node.id);
                }
            });
            
            renderTable();
            updateButtonStates();
            populateClientDropdown();
            updateOptionsSection();
        }

        // Populate client dropdown in Add Engagement dialog
        function populateClientDropdown() {
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = '<option value="">Choose a client...</option>';
            availableClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.clientNumber} - ${client.clientName}`;
                clientSelect.appendChild(option);
            });
        }

        // Handle client selection change
        function onClientChange() {
            const clientSelect = document.getElementById('clientSelect');
            const engagementSelect = document.getElementById('engagementSelect');
            const balanceTypeSelect = document.getElementById('balanceTypeSelect');
            const labelInput = document.getElementById('labelInput');
            
            const selectedClientId = clientSelect.value;
            
            if (!selectedClientId) {
                engagementSelect.disabled = true;
                engagementSelect.innerHTML = '<option value="">Choose an engagement...</option>';
                balanceTypeSelect.disabled = true;
                balanceTypeSelect.innerHTML = '<option value="">Choose balance type...</option>';
                labelInput.value = '';
                return;
            }
            
            const client = availableClients.find(c => c.id === selectedClientId);
            labelInput.value = client.clientName;
            
            engagementSelect.disabled = false;
            engagementSelect.innerHTML = '<option value="">Choose an engagement...</option>';
            client.engagements.forEach(eng => {
                const option = document.createElement('option');
                option.value = eng.id;
                option.dataset.structure = eng.structure;
                option.textContent = `${eng.name} (${eng.date})`;
                engagementSelect.appendChild(option);
            });
            
            balanceTypeSelect.disabled = true;
            balanceTypeSelect.innerHTML = '<option value="">Choose balance type...</option>';
        }

        // Handle engagement selection change
        function onEngagementChange() {
            const engagementSelect = document.getElementById('engagementSelect');
            const balanceTypeSelect = document.getElementById('balanceTypeSelect');
            
            const selectedOption = engagementSelect.options[engagementSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                balanceTypeSelect.disabled = true;
                balanceTypeSelect.innerHTML = '<option value="">Choose balance type...</option>';
                return;
            }
            
            const structure = selectedOption.dataset.structure;
            populateBalanceTypes(structure);
            balanceTypeSelect.disabled = false;
        }

        // Populate balance type dropdown based on structure type
        function populateBalanceTypes(structureType) {
            const balanceTypeSelect = document.getElementById('balanceTypeSelect');
            balanceTypeSelect.innerHTML = '<option value="">Choose balance type...</option>';
            
            const balanceTypes = structureType === 'Consolidated' ? balanceTypesConsolidated : balanceTypesNone;
            
            balanceTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                balanceTypeSelect.appendChild(option);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            function renderNode(node, isVisible = true) {
                if (!node) return;

                const tr = document.createElement('tr');
                tr.dataset.id = node.id;
                tr.dataset.level = node.level;
                if (selectedRowId === node.id) {
                    tr.classList.add('selected');
                }
                if (!isVisible) {
                    tr.style.display = 'none';
                }

                tr.onclick = () => selectRow(node.id);

                const labelTd = document.createElement('td');
                const labelDiv = document.createElement('div');
                labelDiv.className = 'tree-cell';
                labelDiv.style.paddingLeft = (node.level - 1) * 20 + 'px';

                if (node.children && node.children.length > 0) {
                    const toggle = document.createElement('span');
                    toggle.className = 'tree-toggle' + (expandedNodes.has(node.id) ? ' expanded' : '');
                    toggle.textContent = '‚ñ∂';
                    toggle.onclick = (e) => {
                        e.stopPropagation();
                        toggleNode(node.id);
                    };
                    labelDiv.appendChild(toggle);
                } else {
                    const spacer = document.createElement('span');
                    spacer.className = 'tree-spacer';
                    labelDiv.appendChild(spacer);
                }

                const labelText = document.createElement('span');
                labelText.textContent = node.label;
                labelDiv.appendChild(labelText);

                labelTd.appendChild(labelDiv);
                tr.appendChild(labelTd);

                const structureTd = document.createElement('td');
                const structureBadge = document.createElement('span');
                structureBadge.className = 'structure-badge ' + (node.structure === 'Consolidated' ? 'structure-consolidated' : 'structure-none');
                structureBadge.textContent = node.structure;
                structureTd.appendChild(structureBadge);
                tr.appendChild(structureTd);

                tr.appendChild(createTd(node.balance));
                tr.appendChild(createTd(node.clientName));
                tr.appendChild(createTd(node.clientNumber));
                tr.appendChild(createTd(node.engagementName));

                tbody.appendChild(tr);

                // --- FIX START ---
                // The original code iterated through children without sorting, causing the visual order
                // to be incorrect after a move up/down operation.
                // This fix ensures children are always rendered according to their 'displayOrder'.
                if (node.children && node.children.length > 0) {
                    const isExpanded = expandedNodes.has(node.id);

                    // 1. Get the actual child node objects from the main data array.
                    const childNodes = node.children
                        .map(childId => consolidationData.find(n => n.id === childId))
                        .filter(Boolean); // Filter out any potential nulls if data is inconsistent

                    // 2. Sort the child nodes by their displayOrder.
                    childNodes.sort((a, b) => a.displayOrder - b.displayOrder);

                    // 3. Iterate over the *sorted* array and render each node.
                    childNodes.forEach(childNode => {
                        renderNode(childNode, isExpanded && isVisible);
                    });
                }
                // --- FIX END ---
            }
            
            // --- FIX START ---
            // The original code did not sort root nodes, which would also cause ordering issues at the top level.
            // This fix sorts the root nodes by 'displayOrder' before rendering begins.
            const rootNodes = consolidationData
                .filter(n => n.parentId === null)
                .sort((a,b) => a.displayOrder - b.displayOrder);
            // --- FIX END ---
                
            rootNodes.forEach(node => renderNode(node));
        }

        function createTd(text) {
            const td = document.createElement('td');
            td.textContent = text;
            return td;
        }

        function toggleNode(nodeId) {
            if (expandedNodes.has(nodeId)) {
                expandedNodes.delete(nodeId);
            } else {
                expandedNodes.add(nodeId);
            }
            renderTable();
        }

        function selectRow(id) {
            selectedRowId = id;
            renderTable();
            updateButtonStates();
            updateOptionsSection();
        }

        function updateButtonStates() {
            const hasSelection = selectedRowId !== null;
            const selectedNode = hasSelection ? consolidationData.find(n => n.id === selectedRowId) : null;

            document.getElementById('changeParentBtn').disabled = !hasSelection;
            document.getElementById('deleteBtn').disabled = !hasSelection;

            if (hasSelection && selectedNode) {
                const siblings = getSiblings(selectedNode);
                const index = siblings.findIndex(s => s.id === selectedNode.id);
                document.getElementById('moveUpBtn').disabled = index === 0;
                document.getElementById('moveDownBtn').disabled = index === siblings.length - 1;
            } else {
                document.getElementById('moveUpBtn').disabled = true;
                document.getElementById('moveDownBtn').disabled = true;
            }
        }

        function getSiblings(node) {
            return consolidationData.filter(n => n.parentId === node.parentId)
                .sort((a, b) => a.displayOrder - b.displayOrder);
        }

        function markUnsavedChanges() {
            unsavedChanges = true;
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
        }

        // Update Options Section based on selected engagement
        function updateOptionsSection() {
            const optionsSection = document.getElementById('optionsSection');
            
            if (!selectedRowId) {
                optionsSection.innerHTML = `
                    <div class="options-no-selection">
                        <div class="options-no-selection-icon">üìã</div>
                        <div class="options-no-selection-text">Select a consolidated engagement from the table above to view and edit its options</div>
                    </div>
                `;
                return;
            }

            const selectedNode = consolidationData.find(n => n.id === selectedRowId);
            
            if (!selectedNode || selectedNode.structure !== 'Consolidated') {
                optionsSection.innerHTML = `
                    <div class="options-no-selection">
                        <div class="options-no-selection-icon">‚Ñπ</div>
                        <div class="options-no-selection-text">Options are only available for consolidated engagements. The selected engagement has structure type: ${selectedNode ? selectedNode.structure : 'Unknown'}</div>
                    </div>
                `;
                return;
            }

            const directChildren = consolidationData.filter(n => n.parentId === selectedNode.id);
            const setupData = engagementSetupData[selectedNode.id] || { hasAccountGroupings: false, hasTaxSetup: false };
            
            let consolidateByOptions = '<option value="accountNumber">Account Number</option>';
            if (setupData.hasAccountGroupings) {
                consolidateByOptions = `
                    <option value="accountGrouping">Account Grouping</option>
                    <option value="accountGroupingSubcode">Account Grouping with Subcode</option>
                ` + consolidateByOptions;
            }
            if (setupData.hasTaxSetup) {
                consolidateByOptions += '<option value="taxCode">Tax Code</option>';
            }

            optionsSection.innerHTML = `
                <div class="options-header">
                    <div class="options-title-group">
                        <h3 class="options-title">Options</h3>
                        <div class="options-subtitle">
                            Configuration for: <strong id="consolidatedEngagementName">${selectedNode.label}</strong>
                        </div>
                    </div>
                    <div class="consolidated-indicator">
                        <span class="consolidated-indicator-icon">üåê</span>
                        <span id="consolidatedEngagementLabel">${selectedNode.label}</span>
                    </div>
                </div>
                
                <div class="option-group">
                    <label class="option-label">Primary</label>
                    <select class="option-dropdown" id="primaryDropdown" onchange="onPrimaryChange()">
                        ${directChildren.length > 0 ? directChildren.map(child => 
                            `<option value="${child.id}">${child.label}</option>`
                        ).join('') : '<option value="">No child engagements</option>'}
                    </select>
                </div>

                <div class="option-group">
                    <label class="option-label">Consolidate by *</label>
                    <select class="option-dropdown" id="consolidateByDropdown" onchange="onConsolidateByChange()">
                        ${consolidateByOptions}
                    </select>
                </div>

                <div class="option-group">
                    <label class="option-label">Account grouping</label>
                    <select class="option-dropdown" id="accountGroupingDropdown" disabled onchange="markUnsavedChanges()">
                        <option value="leadsheet">Leadsheet</option>
                        <option value="accountClassification">Account Classification</option>
                        <option value="financialStatements">Financial Statements</option>
                    </select>
                </div>

                <div class="option-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeBudgetBalance" onchange="markUnsavedChanges()">
                        <label for="includeBudgetBalance">Include budget balance</label>
                    </div>
                </div>

                <div class="option-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="recalculatePriorYear" onchange="markUnsavedChanges()">
                        <label for="recalculatePriorYear">Recalculate prior year balances</label>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveBtn" onclick="saveChanges()" disabled>Save</button>
                    <button class="btn btn-secondary" onclick="cancelChanges()">Cancel</button>
                </div>
            `;
            
            setTimeout(() => {
                onConsolidateByChange();
            }, 0);
        }

        function onPrimaryChange() {
            markUnsavedChanges();
            const primaryDropdown = document.getElementById('primaryDropdown');
            const selectedPrimaryId = parseInt(primaryDropdown.value);
            
            if (selectedPrimaryId) {
                const setupData = engagementSetupData[selectedPrimaryId] || { hasAccountGroupings: false, hasTaxSetup: false };
                updateConsolidateByOptions(setupData);
            }
        }

        function onConsolidateByChange() {
            markUnsavedChanges();
            
            const consolidateByDropdown = document.getElementById('consolidateByDropdown');
            const accountGroupingDropdown = document.getElementById('accountGroupingDropdown');
            
            if (!consolidateByDropdown || !accountGroupingDropdown) return;
            
            const selectedValue = consolidateByDropdown.value;
            
            if (selectedValue === 'accountGrouping' || selectedValue === 'accountGroupingSubcode') {
                accountGroupingDropdown.disabled = false;
            } else {
                accountGroupingDropdown.disabled = true;
            }
        }

        function updateConsolidateByOptions(setupData) {
            const consolidateByDropdown = document.getElementById('consolidateByDropdown');
            if (!consolidateByDropdown) return;
            
            const currentValue = consolidateByDropdown.value;
            
            let options = '<option value="accountNumber">Account Number</option>';
            if (setupData.hasAccountGroupings) {
                options = `
                    <option value="accountGrouping">Account Grouping</option>
                    <option value="accountGroupingSubcode">Account Grouping with Subcode</option>
                ` + options;
            }
            if (setupData.hasTaxSetup) {
                options += '<option value="taxCode">Tax Code</option>';
            }
            
            consolidateByDropdown.innerHTML = options;
            
            if (consolidateByDropdown.querySelector(`option[value="${currentValue}"]`)) {
                consolidateByDropdown.value = currentValue;
            }
            
            onConsolidateByChange();
        }

        function openAddDialog() {
            document.getElementById('clientSelect').value = '';
            document.getElementById('engagementSelect').value = '';
            document.getElementById('engagementSelect').disabled = true;
            document.getElementById('balanceTypeSelect').value = '';
            document.getElementById('balanceTypeSelect').disabled = true;
            document.getElementById('labelInput').value = '';
            document.getElementById('addEngagementModal').classList.add('show');
        }

        function closeAddDialog() {
            document.getElementById('addEngagementModal').classList.remove('show');
        }

        function addEngagement() {
            const clientSelect = document.getElementById('clientSelect');
            const engagementSelect = document.getElementById('engagementSelect');
            const balanceTypeSelect = document.getElementById('balanceTypeSelect');
            const labelInput = document.getElementById('labelInput');
            
            if (!clientSelect.value || !engagementSelect.value || !balanceTypeSelect.value || !labelInput.value.trim()) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            showToast('Engagement added to consolidation successfully', 'success');
            markUnsavedChanges();
            closeAddDialog();
        }

        function openChangeParentDialog() {
            if (!selectedRowId) return;

            const selectedNode = consolidationData.find(n => n.id === selectedRowId);
            document.getElementById('changeParentTitle').textContent = `Change Parent for ${selectedNode.label}`;

            const parentNode = selectedNode.parentId ? consolidationData.find(n => n.id === selectedNode.parentId) : null;
            document.getElementById('currentParentText').textContent = `Current parent: ${parentNode ? parentNode.label : '(Root level)'}`;

            selectedNewParentId = selectedNode.parentId;
            renderParentSelector('changeParentTreeSelector', selectedRowId);
            document.getElementById('saveParentBtn').disabled = true;
            document.getElementById('changeParentModal').classList.add('show');
        }

        function closeChangeParentDialog() {
            document.getElementById('changeParentModal').classList.remove('show');
            selectedNewParentId = null;
        }

        function renderParentSelector(containerId, currentNodeId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            const rootOption = document.createElement('div');
            rootOption.className = 'tree-node';
            rootOption.textContent = '(None - Move to root level)';
            rootOption.onclick = () => selectParent(containerId, null);
            container.appendChild(rootOption);

            function renderTreeNode(node, level = 0) {
                if (currentNodeId && (node.id === currentNodeId || isDescendant(node.id, currentNodeId))) {
                    return;
                }

                if (node.structure !== 'Consolidated') {
                    return;
                }

                const treeNode = document.createElement('div');
                treeNode.className = 'tree-node';
                treeNode.style.paddingLeft = (level * 20 + 12) + 'px';

                if (currentNodeId && node.id === currentNodeId) {
                    treeNode.classList.add('current');
                }

                const toggle = document.createElement('span');
                toggle.className = 'tree-node-toggle';
                toggle.textContent = node.children && node.children.length > 0 ? '‚ñº' : '';
                treeNode.appendChild(toggle);

                const label = document.createElement('span');
                label.className = 'tree-node-label';
                label.textContent = `${node.label} (Level ${node.level})`;
                treeNode.appendChild(label);

                treeNode.onclick = () => selectParent(containerId, node.id);

                container.appendChild(treeNode);

                if (node.children && node.children.length > 0) {
                    node.children.forEach(childId => {
                        const childNode = consolidationData.find(n => n.id === childId);
                        if (childNode) {
                            renderTreeNode(childNode, level + 1);
                        }
                    });
                }
            }

            const rootNodes = consolidationData.filter(n => n.parentId === null);
            rootNodes.forEach(node => renderTreeNode(node));
        }

        function isDescendant(nodeId, ancestorId) {
            const node = consolidationData.find(n => n.id === nodeId);
            if (!node || !node.parentId) return false;
            if (node.parentId === ancestorId) return true;
            return isDescendant(node.parentId, ancestorId);
        }

        function selectParent(containerId, parentId) {
            selectedNewParentId = parentId;
            const container = document.getElementById(containerId);
            container.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('selected');
            });
            event.target.closest('.tree-node').classList.add('selected');
            
            if (containerId === 'changeParentTreeSelector') {
                const selectedNode = consolidationData.find(n => n.id === selectedRowId);
                if (selectedNode && selectedNewParentId !== selectedNode.parentId) {
                    document.getElementById('saveParentBtn').disabled = false;
                } else {
                    document.getElementById('saveParentBtn').disabled = true;
                }
            }
        }

        function saveParentChange() {
            if (!selectedRowId || selectedNewParentId === undefined) return;
            
            const selectedNode = consolidationData.find(n => n.id === selectedRowId);
            if (!selectedNode) return;
            
            // Remove from old parent's children
            if (selectedNode.parentId !== null) {
                const oldParent = consolidationData.find(n => n.id === selectedNode.parentId);
                if (oldParent && oldParent.children) {
                    oldParent.children = oldParent.children.filter(id => id !== selectedNode.id);
                }
            }
            
            // Update parent
            selectedNode.parentId = selectedNewParentId;
            
            // Update level
            if (selectedNewParentId === null) {
                selectedNode.level = 1;
            } else {
                const newParent = consolidationData.find(n => n.id === selectedNewParentId);
                selectedNode.level = newParent.level + 1;
                
                if (!newParent.children) {
                    newParent.children = [];
                }
                newParent.children.push(selectedNode.id);
            }
            
            // Update descendant levels
            function updateDescendantLevels(nodeId, parentLevel) {
                const children = consolidationData.filter(n => n.parentId === nodeId);
                children.forEach(child => {
                    child.level = parentLevel + 1;
                    updateDescendantLevels(child.id, child.level);
                });
            }
            updateDescendantLevels(selectedNode.id, selectedNode.level);
            
            renderTable();
            updateOptionsSection();
            markUnsavedChanges();
            showToast('Parent changed successfully', 'success');
            closeChangeParentDialog();
        }

        function openDeleteDialog() {
            if (!selectedRowId) return;

            const selectedNode = consolidationData.find(n => n.id === selectedRowId);
            document.getElementById('deleteEngagementName').textContent = selectedNode.label;

            // Count all descendants
            function countDescendants(nodeId) {
                let count = 0;
                const node = consolidationData.find(n => n.id === nodeId);
                if (node && node.children) {
                    count = node.children.length;
                    node.children.forEach(childId => {
                        count += countDescendants(childId);
                    });
                }
                return count;
            }

            const childCount = countDescendants(selectedRowId);
            if (childCount > 0) {
                document.getElementById('deleteWarning').style.display = 'block';
                document.getElementById('childCount').textContent = childCount;
            } else {
                document.getElementById('deleteWarning').style.display = 'none';
            }

            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteDialog() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        function confirmDelete() {
            if (!selectedRowId) return;
            
            const selectedNode = consolidationData.find(n => n.id === selectedRowId);
            
            // Remove from parent's children
            if (selectedNode.parentId !== null) {
                const parent = consolidationData.find(n => n.id === selectedNode.parentId);
                if (parent && parent.children) {
                    parent.children = parent.children.filter(id => id !== selectedRowId);
                }
            }

            // Remove node and all descendants
            function removeDescendants(nodeId) {
                const node = consolidationData.find(n => n.id === nodeId);
                if (node && node.children) {
                    node.children.forEach(childId => removeDescendants(childId));
                }
                consolidationData = consolidationData.filter(n => n.id !== nodeId);
            }

            const childCount = selectedNode.children ? selectedNode.children.length : 0;
            removeDescendants(selectedRowId);
            
            selectedRowId = null;
            renderTable();
            updateButtonStates();
            updateOptionsSection();
            markUnsavedChanges();
            
            if (childCount > 0) {
                showToast(`Engagement and all child engagements removed from consolidation`, 'success');
            } else {
                showToast('Engagement removed from consolidation', 'success');
            }
            
            closeDeleteDialog();
        }

        function moveUp() {
            if (!selectedRowId) return;
            const selectedNode = consolidationData.find(n => n.id === selectedRowId);
            if (!selectedNode) return;
            
            const siblings = getSiblings(selectedNode);
            const index = siblings.findIndex(s => s.id === selectedNode.id);

            if (index > 0) {
                // Swap display orders
                const temp = selectedNode.displayOrder;
                selectedNode.displayOrder = siblings[index - 1].displayOrder;
                siblings[index - 1].displayOrder = temp;

                // Re-render the table to show the change
                renderTable();
                markUnsavedChanges();
                updateButtonStates();
                showToast('Engagement moved up', 'success');
            }
        }

        function moveDown() {
            if (!selectedRowId) return;
            const selectedNode = consolidationData.find(n => n.id === selectedRowId);
            if (!selectedNode) return;
            
            const siblings = getSiblings(selectedNode);
            const index = siblings.findIndex(s => s.id === selectedNode.id);

            if (index < siblings.length - 1) {
                // Swap display orders
                const temp = selectedNode.displayOrder;
                selectedNode.displayOrder = siblings[index + 1].displayOrder;
                siblings[index + 1].displayOrder = temp;

                // Re-render the table to show the change
                renderTable();
                markUnsavedChanges();
                updateButtonStates();
                showToast('Engagement moved down', 'success');
            }
        }

        function saveChanges() {
            setTimeout(() => {
                unsavedChanges = false;
                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.disabled = true;
                }
                showToast('Consolidation structure saved successfully', 'success');
            }, 500);
        }

        function cancelChanges() {
            if (unsavedChanges) {
                if (confirm('You have unsaved changes. Are you sure you want to discard them?')) {
                    unsavedChanges = false;
                    const saveBtn = document.getElementById('saveBtn');
                    if (saveBtn) {
                        saveBtn.disabled = true;
                    }
                    showToast('Changes discarded', 'success');
                    init();
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            messageEl.textContent = message;
            toast.classList.remove('error');
            
            if (type === 'error') {
                toast.classList.add('error');
                icon.textContent = '‚úï';
            } else {
                icon.textContent = '‚úì';
            }

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function goBack() {
            if (unsavedChanges) {
                if (confirm('You have unsaved changes. Do you want to save before leaving?')) {
                    saveChanges();
                }
            }
            alert('Navigate back to Trial Balance');
        }

        window.onload = init;
    </script>
</body>
</html>